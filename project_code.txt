==================================================
FILE PATH: App.tsx
==================================================
import React from 'react';
import { Routes, Route, Navigate, useLocation, useNavigate } from 'react-router-dom';
import { AnimatePresence, motion } from 'framer-motion';
import { MainPage } from './components/MainPage';
import { SetupProfile } from './components/lobby_flow/SetupProfile';
import { CreateLobby } from './components/lobby_flow/CreateLobby';
import { JoinLobby } from './components/lobby_flow/JoinLobby';
import { WaitingRoom } from './components/lobby_flow/WaitingRoom';
import { GameLayout } from './components/game/GameLayout';
import { PlayerCard } from './components/PlayerCard';
import { SystemLog } from './components/Narrator';
import { GameControls } from './components/GameControls';
import { useGameContext } from './contexts/GameContext';

const App: React.FC = () => {
    const location = useLocation();
    const navigate = useNavigate();

    // We use the location as key for AnimatePresence to animate transitions between routes
    return (
        <div className="min-h-screen bg-black text-white selection:bg-green-500 selection:text-black font-sans overflow-hidden">
            <AnimatePresence mode='wait'>
                <Routes location={location} key={location.pathname}>
                    <Route
                        path="/"
                        element={
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="h-full">
                                <MainPage onStart={() => navigate('/setup')} />
                            </motion.div>
                        }
                    />
                    <Route path="/setup" element={<SetupProfile />} />
                    <Route path="/create" element={<CreateLobby />} />
                    <Route path="/join" element={<JoinLobby />} />
                    <Route path="/lobby" element={<WaitingRoom />} />
                    <Route path="/game" element={<GameLayout />} />
                    {/* Fallback */}
                    <Route path="*" element={<Navigate to="/" replace />} />
                </Routes>
            </AnimatePresence>
        </div>
    );
};

export default App;

==================================================
FILE PATH: README.md
==================================================
<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/1mMtdAIR5x0LFFfn_xkTLtjsrMtlL-Jmb

## Run Locally

**Prerequisites:**  Node.js


1. Install dependencies:
   `npm install`
2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
3. Run the app:
   `npm run dev`


==================================================
FILE PATH: components/GameControls.tsx
==================================================
import React from 'react';
import { GamePhase, Role } from '../types';
import { Moon, Sun, Vote } from 'lucide-react';

interface GameControlsProps {
  phase: GamePhase;
  myRole: Role | null;
  dayCount: number;
  onNextPhase: () => void; // Dev tool / Admin simulation
}

export const GameControls: React.FC<GameControlsProps> = ({ phase, myRole, dayCount, onNextPhase }) => {
  
  const getPhaseDisplay = () => {
    switch (phase) {
      case GamePhase.NIGHT:
        return { icon: <Moon className="w-6 h-6 text-indigo-400" />, text: "Night Phase", sub: "Mafia is working..." };
      case GamePhase.DAY:
        return { icon: <Sun className="w-6 h-6 text-amber-400" />, text: "Day Phase", sub: "Discuss events" };
      case GamePhase.VOTING:
        return { icon: <Vote className="w-6 h-6 text-red-400" />, text: "Voting", sub: "Cast your judgment" };
      default:
        return { icon: null, text: phase, sub: "" };
    }
  };

  const display = getPhaseDisplay();

  return (
    <div className="flex flex-col md:flex-row items-center justify-between bg-[#111] p-4 rounded-b-xl border-t border-white/10">
      
      <div className="flex items-center gap-4 mb-4 md:mb-0">
        <div className="w-12 h-12 bg-white/5 rounded-full flex items-center justify-center border border-white/10">
          {display.icon}
        </div>
        <div>
          <h2 className="text-xl font-bold text-white">{display.text} <span className="text-gray-500 text-sm ml-2">Day {dayCount}</span></h2>
          <p className="text-gray-400 text-sm">{display.sub}</p>
        </div>
      </div>

      <div className="flex items-center gap-4">
        {myRole && (
          <div className="text-right mr-4 hidden md:block">
            <div className="text-xs text-gray-500 uppercase tracking-widest">Your Role</div>
            <div className={`font-bold ${myRole === Role.MAFIA ? 'text-red-400' : 'text-blue-400'}`}>{myRole}</div>
          </div>
        )}
        
        {/* Mock Control for Simulation - In Web3 this would be automated by block time or admin */}
        <button 
            onClick={onNextPhase}
            className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded font-medium text-sm transition-colors"
        >
            Simulate Next Phase
        </button>
      </div>
    </div>
  );
};

==================================================
FILE PATH: components/MainPage.tsx
==================================================
import React, { useEffect } from 'react';
import { motion } from 'framer-motion';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import { useAccount } from 'wagmi';
import somniaLogo from '../assets/somniayeal.png';
import mafiaBg from '../assets/mafia1.jpg';

interface MainPageProps {
    onStart: () => void;
}

export const MainPage: React.FC<MainPageProps> = ({ onStart }) => {
    return (
        <div className="relative w-full h-screen overflow-hidden bg-black font-sans flex items-center justify-center">

            {/* Background Image */}
            <div className="absolute inset-0 z-0">
                <img
                    src={mafiaBg}
                    alt="Background"
                    className="w-full h-full object-cover opacity-80"
                />
            </div>

            <div className="absolute inset-0 bg-black/30 z-0" />

            {/* Content Container */}
            <div className="relative z-10 w-full flex flex-col items-center justify-center p-4">

                {/* Main Title */}
                <motion.div
                    initial={{ opacity: 0, y: 30 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 1.2, ease: "easeOut" }}
                    className="w-full max-w-[90vw] md:max-w-[800px]"
                >
                    <svg viewBox="0 0 600 120" className="w-full h-auto overflow-visible">
                        <text
                            x="50%"
                            y="60%"
                            dominantBaseline="middle"
                            textAnchor="middle"
                            fill="#ffffff"
                            stroke="#000000"
                            strokeWidth="0"
                            strokeOpacity="0"
                            strokeLinecap="square"
                            strokeLinejoin="bevel"
                            textRendering="auto"
                            letterSpacing="1.44"
                            style={{
                                fontFamily: '"Playfair Display", serif',
                                fontSize: '72px',
                                fontStyle: 'italic',
                                fontWeight: 900,
                                filter: 'drop-shadow(0px 4px 6px rgba(0,0,0,0.5))'
                            }}
                        >
                            Mafia Online
                        </text>
                    </svg>
                </motion.div>

                {/* Subtitle Row */}
                <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.5, duration: 1 }}
                    className="flex flex-row items-center justify-center gap-2 mt-[-10px] md:mt-[-20px]"
                >
                    <p
                        style={{
                            fontFamily: '"Montserrat", sans-serif',
                            color: '#ffb01d',
                            textTransform: 'uppercase',
                            letterSpacing: '0.2em',
                            fontWeight: 600,
                            textShadow: '0px 2px 4px rgba(0,0,0,0.6)'
                        }}
                        className="text-[10px] md:text-[14px] lg:text-[18px] whitespace-nowrap"
                    >
                        On Somnia Network
                    </p>

                    <img
                        src={somniaLogo}
                        alt="Somnia"
                        className="h-6 md:h-8 lg:h-10 w-auto object-contain drop-shadow-md"
                    />
                </motion.div>

                {/* CONNECT / ENTER Button */}
                <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    transition={{ delay: 1.5, duration: 0.5 }}
                    className="mt-16"
                >
                    <ConnectButton.Custom>
                        {({
                            account,
                            chain,
                            openAccountModal,
                            openChainModal,
                            openConnectModal,
                            authenticationStatus,
                            mounted,
                        }) => {
                            // Note: If your app doesn't use authentication, you
                            // can remove all 'authenticationStatus' checks
                            const ready = mounted && authenticationStatus !== 'loading';
                            const connected =
                                ready &&
                                account &&
                                chain &&
                                (!authenticationStatus ||
                                    authenticationStatus === 'authenticated');

                            return (
                                <div
                                    {...(!ready && {
                                        'aria-hidden': true,
                                        'style': {
                                            opacity: 0,
                                            pointerEvents: 'none',
                                            userSelect: 'none',
                                        },
                                    })}
                                >
                                    {(() => {
                                        if (!connected) {
                                            return (
                                                <button
                                                    onClick={openConnectModal}
                                                    className="px-8 py-3 rounded-xl font-mono font-bold text-black shadow-[0_0_15px_rgba(231,213,113,0.3)] hover:shadow-[0_0_25px_rgba(231,213,113,0.6)] hover:scale-105 transition-all text-sm md:text-base tracking-wider relative overflow-hidden ring-1 ring-white/10"
                                                    style={{
                                                        background: 'linear-gradient(90deg, #E7D571 0%, #615511 100%)',
                                                    }}
                                                >
                                                    <span className="relative z-10">CONNECT WALLET</span>
                                                    {/* Shine effect overlay */}
                                                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] hover:translate-x-[100%] transition-transform duration-1000" />
                                                </button>
                                            );
                                        }

                                        if (chain.unsupported) {
                                            return (
                                                <button
                                                    onClick={openChainModal}
                                                    className="px-8 py-3 rounded-xl font-mono font-bold text-white bg-red-600 shadow-lg hover:scale-105 transition-all text-sm md:text-base tracking-wider ring-1 ring-red-400/50"
                                                >
                                                    WRONG NETWORK
                                                </button>
                                            );
                                        }

                                        return (
                                            <button
                                                onClick={onStart}
                                                className="px-8 py-3 rounded-xl font-mono font-bold text-black shadow-[0_0_15px_rgba(231,213,113,0.3)] hover:shadow-[0_0_25px_rgba(231,213,113,0.6)] hover:scale-105 transition-all text-sm md:text-base tracking-wider relative overflow-hidden ring-1 ring-white/10"
                                                style={{
                                                    background: 'linear-gradient(90deg, #E7D571 0%, #615511 100%)',
                                                }}
                                            >
                                                <span className="relative z-10">ENTER CITY</span>
                                                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] hover:translate-x-[100%] transition-transform duration-1000" />
                                            </button>
                                        );
                                    })()}
                                </div>
                            );
                        }}
                    </ConnectButton.Custom>

                </motion.div>

            </div>
        </div>
    );
};

==================================================
FILE PATH: components/Narrator.tsx
==================================================
import React, { useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Terminal, Activity } from 'lucide-react';
import { LogEntry } from '../types';

interface SystemLogProps {
  logs: LogEntry[];
}

export const SystemLog: React.FC<SystemLogProps> = ({ logs }) => {
  const scrollRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to bottom
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [logs]);

  const getLogStyle = (type: LogEntry['type']) => {
    switch (type) {
      case 'danger': return 'text-red-400 border-l-2 border-red-500 pl-2';
      case 'success': return 'text-green-400 border-l-2 border-green-500 pl-2';
      case 'warning': return 'text-amber-400 border-l-2 border-amber-500 pl-2';
      case 'phase': return 'text-purple-300 font-bold border-l-2 border-purple-500 pl-2 mt-2 pt-2 border-t border-t-white/10';
      default: return 'text-gray-300';
    }
  };

  return (
    <div className="w-full max-w-4xl mx-auto mb-6 relative z-10">
      <div className="absolute -inset-0.5 bg-gradient-to-b from-gray-800 to-black rounded-lg opacity-50"></div>
      
      <div className="relative bg-[#090909] border border-white/10 rounded-lg overflow-hidden shadow-2xl flex flex-col h-[200px]">
        
        {/* Header */}
        <div className="bg-[#111] px-4 py-2 flex items-center justify-between border-b border-white/10">
          <div className="flex items-center gap-2">
            <Terminal className="w-4 h-4 text-green-500" />
            <span className="text-xs font-mono text-green-500 uppercase tracking-widest">System Log</span>
          </div>
          <div className="flex gap-1.5">
            <div className="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/50"></div>
            <div className="w-2.5 h-2.5 rounded-full bg-amber-500/20 border border-amber-500/50"></div>
            <div className="w-2.5 h-2.5 rounded-full bg-green-500/20 border border-green-500/50"></div>
          </div>
        </div>

        {/* Log Area */}
        <div 
            ref={scrollRef}
            className="flex-1 overflow-y-auto p-4 font-mono text-sm space-y-2 scroll-smooth"
        >
          <AnimatePresence initial={false}>
            {logs.map((log) => (
              <motion.div
                key={log.id}
                initial={{ opacity: 0, x: -10 }}
                animate={{ opacity: 1, x: 0 }}
                className={`flex gap-3 ${getLogStyle(log.type)}`}
              >
                <span className="opacity-40 select-none">[{log.timestamp}]</span>
                <span>{log.message}</span>
              </motion.div>
            ))}
            {logs.length === 0 && (
                <div className="text-gray-600 italic">Waiting for connection...</div>
            )}
          </AnimatePresence>
        </div>

        {/* Scanline Effect */}
        <div className="absolute inset-0 bg-gradient-to-b from-transparent to-black/10 pointer-events-none" style={{ backgroundSize: '100% 4px' }}></div>
      </div>
    </div>
  );
};

==================================================
FILE PATH: components/PlayerCard.tsx
==================================================
import React from 'react';
import { motion } from 'framer-motion';
import { User, Shield, Crosshair, Eye, Skull, Wifi, WifiOff, AlertTriangle } from 'lucide-react';
import { Player, Role, cardVariants } from '../types';

interface PlayerCardProps {
  player: Player;
  isMe: boolean;
  onAction: (playerId: string) => void;
  canAct: boolean;
  actionLabel: string;
}

export const PlayerCard: React.FC<PlayerCardProps> = ({ player, isMe, onAction, canAct, actionLabel }) => {
  
  const getRoleIcon = (role: Role) => {
    switch (role) {
      case Role.MAFIA: return <Crosshair className="w-4 h-4 text-red-500" />;
      case Role.DOCTOR: return <Shield className="w-4 h-4 text-green-500" />;
      case Role.DETECTIVE: return <Eye className="w-4 h-4 text-blue-500" />;
      default: return <User className="w-4 h-4 text-gray-400" />;
    }
  };

  const getStatusIndicator = () => {
    if (!player.isAlive) return null; // Skull handles death
    switch (player.status) {
        case 'connected': 
            return <div className="flex items-center gap-1 text-[10px] text-green-500 bg-green-500/10 px-1.5 py-0.5 rounded border border-green-500/20"><Wifi className="w-3 h-3" /> <span className="hidden md:inline">SYNC</span></div>;
        case 'syncing': 
            return <div className="flex items-center gap-1 text-[10px] text-amber-500 bg-amber-500/10 px-1.5 py-0.5 rounded border border-amber-500/20"><Wifi className="w-3 h-3 animate-pulse" /> SYNCING</div>;
        case 'offline': 
            return <div className="flex items-center gap-1 text-[10px] text-red-500 bg-red-500/10 px-1.5 py-0.5 rounded border border-red-500/20"><WifiOff className="w-3 h-3" /> LOST</div>;
        case 'slashed': 
            return <div className="flex items-center gap-1 text-[10px] text-red-500 font-bold bg-red-500/20 px-1.5 py-0.5 rounded border border-red-500/40"><AlertTriangle className="w-3 h-3" /> SLASHED</div>;
    }
  };

  return (
    <motion.div
      variants={cardVariants}
      className={`relative group ${!player.isAlive || player.status === 'slashed' ? 'opacity-50 grayscale' : ''}`}
    >
      {/* Selection Ring */}
      <div className={`absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl blur opacity-0 group-hover:opacity-75 transition duration-500 ${isMe ? 'opacity-50' : ''}`}></div>
      
      <div className="relative bg-[#1a1a1a] border border-white/5 rounded-xl p-4 flex flex-col items-center gap-3 shadow-lg overflow-hidden min-h-[160px]">
        
        {/* Status Badge */}
        {!player.isAlive && (
          <div className="absolute inset-0 bg-black/60 flex items-center justify-center z-20 backdrop-blur-[1px]">
            <Skull className="w-12 h-12 text-red-600/80" />
          </div>
        )}

        {/* Header: Status */}
        <div className="w-full flex justify-end">
            {getStatusIndicator()}
        </div>

        {/* Avatar */}
        <div className="w-16 h-16 rounded-full overflow-hidden border-2 border-white/10 relative z-10">
          <img src={player.avatarUrl} alt={player.name} className="w-full h-full object-cover" />
        </div>

        {/* Info */}
        <div className="text-center z-10 w-full">
          <div className="flex items-center justify-center gap-2 mb-1">
            <h3 className="font-bold text-white text-sm truncate">{player.name}</h3>
            {isMe && <span className="text-[10px] bg-blue-900/50 text-blue-300 px-1.5 py-0.5 rounded border border-blue-500/30">YOU</span>}
          </div>
          <div className="text-xs text-gray-500 font-mono truncate px-2">
            {player.address.slice(0, 6)}...{player.address.slice(-4)}
          </div>
        </div>

        {/* Revealed Role */}
        {(isMe || !player.isAlive) && (
          <div className="mt-1 flex items-center gap-1 bg-white/5 px-2 py-1 rounded-full border border-white/5">
            {getRoleIcon(player.role)}
            <span className="text-[10px] font-bold tracking-wider text-gray-300">{player.role}</span>
          </div>
        )}

        {/* Action Button */}
        {canAct && player.isAlive && !isMe && player.status !== 'slashed' && (
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={() => onAction(player.id)}
            className="mt-2 w-full py-1.5 px-3 bg-white/10 hover:bg-white/20 text-white text-xs font-bold rounded border border-white/10 transition-colors uppercase tracking-widest z-20"
          >
            {actionLabel}
          </motion.button>
        )}
      </div>
    </motion.div>
  );
};

==================================================
FILE PATH: components/Web3Provider.tsx
==================================================
import React from 'react';
import '@rainbow-me/rainbowkit/styles.css';
import {
  getDefaultConfig,
  RainbowKitProvider,
  darkTheme,
} from '@rainbow-me/rainbowkit';
import { WagmiProvider } from 'wagmi';
import {
  QueryClientProvider,
  QueryClient,
} from "@tanstack/react-query";
import { defineChain } from 'viem';

const somniaTestnet = defineChain({
  id: 50312,
  name: 'Somnia Testnet',
  nativeCurrency: {
    decimals: 18,
    name: 'Somnia Testnet Token',
    symbol: 'STT',
  },
  rpcUrls: {
    default: { http: ['https://dream-rpc.somnia.network'] },
  },
  blockExplorers: {
    default: { name: 'Somnia Explorer', url: 'https://somnia-testnet.socialscan.io' },
  },
  testnet: true,
});

const config = getDefaultConfig({
  appName: 'Somnia Mafia',
  projectId: 'YOUR_PROJECT_ID',
  chains: [somniaTestnet],
  ssr: false,
});

const queryClient = new QueryClient();

export const Web3Provider = ({ children }: { children: React.ReactNode }) => {
  return (
    <WagmiProvider config={config}>
      <QueryClientProvider client={queryClient}>
        <RainbowKitProvider theme={darkTheme()}>
          {children}
        </RainbowKitProvider>
      </QueryClientProvider>
    </WagmiProvider>
  );
};


==================================================
FILE PATH: components/game/GameLayout.tsx
==================================================
import React, { useMemo } from 'react';
import { motion } from 'framer-motion';
import { useGameContext } from '../../contexts/GameContext';
import { GameLog } from './GameLog';
import { PlayerSpot } from './PlayerSpot';
import { PhaseIndicator } from './PhaseIndicator';
import { Button } from '../ui/Button';
import { GamePhase } from '../../types';
import { MOCK_PLAYERS } from '../../services/mockData';
import lobbyBg from '../../assets/game_background.png';
import { BackButton } from '../ui/BackButton';

export const GameLayout: React.FC = () => {
    const { gameState, setGameState, handleNextPhase, handlePlayerAction, canActOnPlayer, getActionLabel } = useGameContext();
    const players = gameState.players || [];

    // --- ЛОГИКА РАССАДКИ ---
    const { topRow, bottomRow, leftCol, rightCol } = useMemo(() => {
        const p = [...players];
        // Балансируем: 5 сверху, 5 снизу, остальные по бокам
        return {
            topRow: p.slice(0, 5),
            rightCol: p.slice(5, 8),
            bottomRow: p.slice(8, 13),
            leftCol: p.slice(13, 16)
        };
    }, [players]);

    const loadMockData = () => {
        setGameState(prev => ({
            ...prev,
            players: MOCK_PLAYERS,
            myPlayerId: 'p-0',
            dayCount: 1,
            phase: GamePhase.DAY
        }));
    };

    // --- FIX КНОПКИ ---
    const onNextPhaseClick = (e: React.MouseEvent) => {
        e.preventDefault();
        e.stopPropagation();
        handleNextPhase();
    };

    if (players.length === 0) {
        return (
            <div className="w-full h-screen bg-black flex flex-col items-center justify-center gap-4 text-white">
                <div className="fixed inset-0 z-0 bg-cover bg-center opacity-30" style={{ backgroundImage: `url(${lobbyBg})` }} />
                <h2 className="text-2xl font-['Playfair_Display'] z-10">Game Session Not Found</h2>
                <Button onClick={loadMockData} className="z-10 px-8 pointer-events-auto">Load Mock Simulation</Button>
            </div>
        );
    }

    return (
        <div className="relative w-full h-screen overflow-hidden bg-[#050505] font-['Montserrat']">

            {/* 1. ФОН */}
            <div className="absolute inset-0 z-0 pointer-events-none">
                <div
                    className="absolute inset-0 bg-cover bg-center transition-all duration-1000 ease-in-out"
                    style={{
                        backgroundImage: `url(${lobbyBg})`,
                        filter: gameState.phase === GamePhase.NIGHT
                            ? 'grayscale(100%) brightness(25%) contrast(120%)'
                            : 'grayscale(30%) brightness(40%)'
                    }}
                />
                {/* Стол */}
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] h-[88%] rounded-[80px] border border-white/5 bg-[#916A47]/[0.02] shadow-[0_0_150px_rgba(0,0,0,0.6)_inset]" />
                <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_30%,#000_100%)]" />
            </div>

            {/* 2. HEADER HUD */}
            <div className="absolute top-0 left-0 right-0 z-40 h-16 px-6 flex items-center justify-between pointer-events-none select-none">
                {/* Левая часть */}
                <div className="flex items-center gap-4 pointer-events-auto">
                    <BackButton to="/lobby" className="bg-black/40 p-2 rounded-full hover:bg-[#916A47]" label="" />
                    <div className="hidden md:block">
                        <h1 className="text-white font-['Playfair_Display'] text-lg tracking-wider">Somnia Mafia</h1>
                    </div>
                </div>

                {/* Центр: Индикатор фазы */}
                <div className="absolute left-1/2 -translate-x-1/2 top-3 pointer-events-auto">
                    <PhaseIndicator phase={gameState.phase} dayCount={gameState.dayCount} />
                </div>

                {/* Правая часть: Кнопка DEV */}
                <div className="pointer-events-auto flex items-center gap-2">
                    <Button
                        onClick={onNextPhaseClick}
                        variant="outline-gold"
                        className="h-8 text-[10px] px-4 bg-black/60 backdrop-blur border-[#916A47]/40 hover:bg-[#916A47] hover:text-black shadow-[0_0_20px_rgba(145,106,71,0.2)] active:scale-95 transition-all z-50"
                    >
                        NEXT PHASE (DEV)
                    </Button>
                </div>
            </div>

            {/* 3. MAIN ARENA GRID */}
            {/*
                GRID CONFIG:
                Columns: [260px] [1fr (auto)] [260px]  -> Бока фиксированы, центр резиновый
                Rows:    [130px] [1fr (auto)] [130px]  -> Верх/Низ фиксированы, центр резиновый
            */}
            <div className="relative z-10 w-full h-full pt-16 pb-2 px-2 md:px-6 container mx-auto flex flex-col md:grid md:grid-cols-[260px_minmax(0,1fr)_260px] md:grid-rows-[130px_minmax(0,1fr)_130px]">

                {/* --- TOP ROW (5 Players) --- */}
                {/* col-span-3 означает растянуться на всю ширину. z-20 чтобы быть над столом */}
                <div className="hidden md:flex col-span-3 row-start-1 justify-center items-start gap-4 lg:gap-12 z-20 pt-2">
                    {topRow.map(player => (
                        <div key={player.id} className="w-[130px] lg:w-[140px] flex justify-center">
                            <PlayerSpot
                                player={player}
                                isMe={player.id === gameState.myPlayerId}
                                onClick={() => handlePlayerAction(player.id)}
                                canAct={canActOnPlayer(player)}
                            />
                        </div>
                    ))}
                </div>

                {/* --- LEFT COLUMN (3 Players) --- */}
                <div className="hidden md:flex col-start-1 row-start-2 flex-col justify-center gap-4 lg:gap-8 items-start pl-2">
                    {leftCol.map(player => (
                        <div key={player.id} className="w-[180px]">
                            <PlayerSpot
                                player={player}
                                isMe={player.id === gameState.myPlayerId}
                                onClick={() => handlePlayerAction(player.id)}
                                canAct={canActOnPlayer(player)}
                            />
                        </div>
                    ))}
                </div>

                {/* --- CENTER LOG (The Feed) --- */}
                <div className="flex-1 col-start-2 row-start-2 flex flex-col justify-center items-center min-h-0 min-w-0 px-4 py-2 relative">

                    {/* Banner */}
                    <motion.div
                        key={gameState.phase}
                        initial={{ opacity: 0, y: -10 }}
                        animate={{ opacity: 1, y: 0 }}
                        className="mb-3 text-center pointer-events-none"
                    >
                        <span className="inline-block px-3 py-1 rounded-md bg-black/40 border border-[#916A47]/20 text-[#916A47] text-[10px] font-bold tracking-widest uppercase backdrop-blur-sm">
                            {getActionLabel() === "VOTE" ? "Target Required" : "Live Feed"}
                        </span>
                    </motion.div>

                    {/* Log Container - Ограничен по высоте и ширине */}
                    <div className="w-full h-full max-h-[500px] max-w-3xl rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.5)] overflow-hidden border border-white/5 relative bg-[#050505]/60 backdrop-blur-sm group">
                        <GameLog />
                    </div>
                </div>

                {/* --- RIGHT COLUMN (3 Players) --- */}
                <div className="hidden md:flex col-start-3 row-start-2 flex-col justify-center gap-4 lg:gap-8 items-end pr-2">
                    {rightCol.map(player => (
                        <div key={player.id} className="w-[180px] flex justify-end">
                            <div className="w-full">
                                <PlayerSpot
                                    player={player}
                                    isMe={player.id === gameState.myPlayerId}
                                    onClick={() => handlePlayerAction(player.id)}
                                    canAct={canActOnPlayer(player)}
                                />
                            </div>
                        </div>
                    ))}
                </div>

                {/* --- BOTTOM ROW (5 Players) --- */}
                <div className="hidden md:flex col-span-3 row-start-3 justify-center items-end gap-4 lg:gap-12 z-20 pb-2">
                    {bottomRow.map(player => (
                        <div key={player.id} className="w-[130px] lg:w-[140px] flex justify-center">
                            <PlayerSpot
                                player={player}
                                isMe={player.id === gameState.myPlayerId}
                                onClick={() => handlePlayerAction(player.id)}
                                canAct={canActOnPlayer(player)}
                            />
                        </div>
                    ))}
                </div>

                {/* --- MOBILE LAYOUT --- */}
                <div className="md:hidden flex-1 flex flex-col h-full overflow-hidden">
                    <div className="flex-1 min-h-0 mb-3 relative">
                        <GameLog />
                    </div>
                    {/* Горизонтальный скролл игроков */}
                    <div className="h-[130px] shrink-0 bg-[#0a0a0a]/50 backdrop-blur-md border-t border-white/5 -mx-4 px-4 py-2">
                        <div className="flex gap-3 overflow-x-auto h-full items-center snap-x no-scrollbar">
                            {players.map((player) => (
                                <div key={player.id} className="min-w-[110px] snap-center">
                                    <PlayerSpot
                                        player={player}
                                        isMe={player.id === gameState.myPlayerId}
                                        onClick={() => handlePlayerAction(player.id)}
                                        canAct={canActOnPlayer(player)}
                                    />
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    );
};

==================================================
FILE PATH: components/game/GameLog.tsx
==================================================
import React, { useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useGameContext } from '../../contexts/GameContext';
import { Activity } from 'lucide-react';

export const GameLog: React.FC = () => {
    const { gameState } = useGameContext();
    const scrollRef = useRef<HTMLDivElement>(null);

    // Автоскролл вниз
    useEffect(() => {
        if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }
    }, [gameState.logs]);

    const getLogColor = (type: string) => {
        switch (type) {
            case 'danger': return 'text-red-400 border-l-2 border-red-500/50 pl-2';
            case 'success': return 'text-green-400 border-l-2 border-green-500/50 pl-2';
            case 'phase': return 'text-[#916A47] font-bold border-l-2 border-[#916A47] pl-2 py-2 my-1 bg-[#916A47]/10';
            case 'warning': return 'text-amber-400';
            default: return 'text-white/60';
        }
    };

    return (
        <div className="flex flex-col h-full bg-[#0a0a0a]/80 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden shadow-2xl">
            {/* Заголовок лога */}
            <div className="flex items-center justify-between px-4 py-3 border-b border-white/5 bg-white/[0.02]">
                <div className="flex items-center gap-2">
                    <Activity className="w-4 h-4 text-[#916A47]" />
                    <span className="text-xs font-mono text-white/40 uppercase tracking-widest">Game Feed</span>
                </div>
                <div className="flex gap-1">
                    <div className="w-1.5 h-1.5 rounded-full bg-red-500/20" />
                    <div className="w-1.5 h-1.5 rounded-full bg-amber-500/20" />
                    <div className="w-1.5 h-1.5 rounded-full bg-green-500/20" />
                </div>
            </div>

            {/* Контент */}
            <div
                ref={scrollRef}
                className="flex-1 overflow-y-auto p-4 space-y-2 font-mono text-xs md:text-sm custom-scrollbar"
            >
                <AnimatePresence initial={false}>
                    {gameState.logs.map((log) => (
                        <motion.div
                            key={log.id}
                            initial={{ opacity: 0, x: -10 }}
                            animate={{ opacity: 1, x: 0 }}
                            className={`${getLogColor(log.type)} transition-colors`}
                        >
                            <span className="opacity-30 mr-2">[{log.timestamp}]</span>
                            <span>{log.message}</span>
                        </motion.div>
                    ))}
                </AnimatePresence>

                {gameState.logs.length === 0 && (
                    <div className="h-full flex flex-col items-center justify-center text-white/20 italic">
                        <span>Waiting for events...</span>
                    </div>
                )}
            </div>
        </div>
    );
};

==================================================
FILE PATH: components/game/PhaseIndicator.tsx
==================================================
import React from 'react';
import { motion } from 'framer-motion';
import { GamePhase } from '../../types';
import { Sun, Moon, Vote, Skull } from 'lucide-react';

interface PhaseIndicatorProps {
    phase: GamePhase;
    dayCount: number;
}

export const PhaseIndicator: React.FC<PhaseIndicatorProps> = ({ phase, dayCount }) => {
    const isNight = phase === GamePhase.NIGHT;

    const getConfig = () => {
        switch (phase) {
            case GamePhase.NIGHT:
                return { icon: <Moon className="w-5 h-5" />, label: "Night Phase", color: "bg-indigo-950/50 text-indigo-300 border-indigo-500/30" };
            case GamePhase.DAY:
                return { icon: <Sun className="w-5 h-5" />, label: "Day Phase", color: "bg-amber-950/50 text-amber-300 border-amber-500/30" };
            case GamePhase.VOTING:
                return { icon: <Vote className="w-5 h-5" />, label: "Voting Session", color: "bg-red-950/50 text-red-300 border-red-500/30" };
            case GamePhase.GAME_OVER:
                return { icon: <Skull className="w-5 h-5" />, label: "Game Over", color: "bg-gray-900 text-gray-300 border-gray-700" };
            default:
                return { icon: <div className="w-5 h-5 rounded-full border-2 border-current border-dashed animate-spin" />, label: "Syncing...", color: "bg-gray-900 text-gray-400 border-gray-800" };
        }
    };

    const config = getConfig();

    return (
        <motion.div
            key={phase}
            initial={{ y: -20, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            className={`
                flex items-center gap-3 px-6 py-2 rounded-full border backdrop-blur-md shadow-lg
                ${config.color}
            `}
        >
            {config.icon}
            <div className="flex flex-col leading-none">
                <span className="text-[10px] uppercase font-bold tracking-widest opacity-60">Status</span>
                <span className="text-sm font-bold font-['Montserrat']">{config.label} • Day {dayCount}</span>
            </div>
        </motion.div>
    );
};

==================================================
FILE PATH: components/game/PlayerSpot.tsx
==================================================
import React from 'react';
import { motion } from 'framer-motion';
import { Player, Role } from '../../types';
import { Shield, Crosshair, Eye, Skull } from 'lucide-react';

interface PlayerSpotProps {
    player: Player;
    onClick: () => void;
    isMe: boolean;
    canAct: boolean;
}

export const PlayerSpot: React.FC<PlayerSpotProps> = ({ player, onClick, isMe, canAct }) => {
    
    // Иконка роли (видна только мне или если игрок мертв/раскрыт)
    const getRoleIcon = () => {
        if (!isMe && player.isAlive && player.role === Role.UNKNOWN) return null;
        
        // В реальной игре роль других видна только после смерти или в конце
        // Для демо показываем свою роль
        switch (player.role) {
            case Role.MAFIA: return <Crosshair className="w-3 h-3 text-red-500" />;
            case Role.DOCTOR: return <Shield className="w-3 h-3 text-green-500" />;
            case Role.DETECTIVE: return <Eye className="w-3 h-3 text-blue-500" />;
            default: return null;
        }
    };

    return (
        <motion.div
            layout
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: player.isAlive ? 1 : 0.5, scale: 1 }}
            whileHover={player.isAlive && canAct ? { scale: 1.05, y: -5 } : {}}
            onClick={() => (player.isAlive && canAct ? onClick() : null)}
            className={`
                relative flex flex-col items-center gap-2 p-3 rounded-xl transition-all duration-300
                ${canAct && player.isAlive ? 'cursor-pointer hover:bg-white/5' : 'cursor-default'}
                ${isMe ? 'bg-[#916A47]/10 border border-[#916A47]/50' : 'bg-[#19130D]/60 border border-white/5'}
            `}
        >
            {/* Аватар */}
            <div className="relative">
                <div className={`
                    w-16 h-16 md:w-20 md:h-20 rounded-full overflow-hidden border-2 
                    ${isMe ? 'border-[#916A47] shadow-[0_0_15px_rgba(145,106,71,0.3)]' : 'border-white/10'}
                    ${!player.isAlive ? 'grayscale opacity-50' : ''}
                `}>
                    <img src={player.avatarUrl} alt={player.name} className="w-full h-full object-cover" />
                </div>
                
                {/* Бейдж смерти */}
                {!player.isAlive && (
                    <div className="absolute inset-0 flex items-center justify-center bg-black/60 rounded-full">
                        <Skull className="w-8 h-8 text-white/80" />
                    </div>
                )}

                {/* Индикатор статуса (онлайн/оффлайн) */}
                {player.isAlive && (
                    <div className={`
                        absolute bottom-0 right-0 w-4 h-4 rounded-full border-2 border-[#19130D]
                        ${player.status === 'connected' ? 'bg-green-500' : 'bg-red-500'}
                    `} />
                )}
            </div>

            {/* Инфо */}
            <div className="text-center w-full">
                <div className="flex items-center justify-center gap-1">
                    <span className={`text-xs md:text-sm font-bold truncate max-w-[100px] ${isMe ? 'text-[#916A47]' : 'text-white/90'}`}>
                        {player.name}
                    </span>
                    {getRoleIcon()}
                </div>
                <div className="text-[10px] text-white/30 font-mono">
                    {player.address.slice(0, 4)}...{player.address.slice(-4)}
                </div>
            </div>
            
            {/* Метка "ВЫ" */}
            {isMe && (
                <div className="absolute -top-2 px-2 py-0.5 bg-[#916A47] text-black text-[8px] font-bold uppercase tracking-wider rounded-full">
                    YOU
                </div>
            )}
        </motion.div>
    );
};

==================================================
FILE PATH: components/lobby_flow/CreateLobby.tsx
==================================================
import React, { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import { useGameContext } from '../../contexts/GameContext';
import lobbyBg from '../../assets/lobby_background.png';
import { Button } from '../ui/Button';
import { Input } from '../ui/Input';
import { BackButton } from '../ui/BackButton';

export const CreateLobby: React.FC = () => {
    const {
        lobbyName,
        setLobbyName,
        createLobbyOnChain,
        isTxPending,
        currentRoomId
    } = useGameContext();

    const navigate = useNavigate();

    // Как только транзакция прошла и контракт выдал нам ID комнаты — идем в ожидание
    useEffect(() => {
        if (currentRoomId !== null) {
            navigate('/lobby');
        }
    }, [currentRoomId, navigate]);

    const handleCreate = async () => {
        if (!lobbyName.trim() || isTxPending) return;
        await createLobbyOnChain();
    };

    return (
        <div className="relative w-full min-h-screen font-['Montserrat'] flex items-center justify-center p-4">
            <div className="fixed inset-0 z-0 bg-cover bg-center bg-no-repeat"
                style={{ backgroundImage: `url(${lobbyBg})` }}
            >
                <div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" />
            </div>

            <motion.div
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -20 }}
                className="relative z-10 w-full max-w-[600px] flex flex-col items-center gap-8 py-10"
            >
                <div className="w-full flex items-center justify-start">
                    <BackButton />
                </div>

                <div className="w-full bg-[rgba(40,22,8,0.70)] backdrop-blur-md rounded-[42px] p-8 border border-white/10 shadow-xl flex flex-col gap-6 items-center">
                    <h2 className="text-white text-2xl font-['Montserrat']">Name Your Lobby</h2>
                    <Input
                        value={lobbyName}
                        onChange={(e) => setLobbyName(e.target.value)}
                        placeholder="e.g. Best Mafia Game"
                        autoFocus
                        disabled={isTxPending}
                        containerClassName="w-full"
                        className="h-[60px] !font-['Montserrat']"
                    />
                </div>

                <Button
                    onClick={handleCreate}
                    isLoading={isTxPending}
                    disabled={!lobbyName.trim() || isTxPending}
                    className="w-full h-[60px] text-xl"
                >
                    {isTxPending ? "Deploying on Somnia..." : "Create & Enter"}
                </Button>
            </motion.div>
        </div>
    );
};

==================================================
FILE PATH: components/lobby_flow/JoinLobby.tsx
==================================================
import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import { useGameContext } from '../../contexts/GameContext';
import lobbyBg from '../../assets/lobby_background.png';
import { BackButton } from '../ui/BackButton';
import { usePublicClient } from 'wagmi';
import { MAFIA_CONTRACT_ADDRESS, MAFIA_ABI } from '../../contracts/config';

export const JoinLobby: React.FC = () => {
    const { setLobbyName, joinLobbyOnChain, isTxPending } = useGameContext();
    const navigate = useNavigate();
    const publicClient = usePublicClient();
    const [rooms, setRooms] = useState<any[]>([]);
    const [isLoading, setIsLoading] = useState(true);

    // Получаем список комнат прямо из блокчейна
    useEffect(() => {
        const fetchRooms = async () => {
            if (!publicClient) return;
            try {
                // Узнаем сколько всего комнат было создано
                const nextId = await publicClient.readContract({
                    address: MAFIA_CONTRACT_ADDRESS,
                    abi: MAFIA_ABI,
                    functionName: 'nextRoomId',
                }) as bigint;

                const roomList = [];
                // Берем последние 10 комнат (или меньше, если их нет)
                const start = nextId > 10n ? nextId - 10n : 1n;

                for (let i = nextId - 1n; i >= start; i--) {
                    const roomData = await publicClient.readContract({
                        address: MAFIA_CONTRACT_ADDRESS,
                        abi: MAFIA_ABI,
                        functionName: 'rooms',
                        args: [i],
                    }) as any;

                    // roomData[2] это фаза (0 = LOBBY)
                    if (roomData[2] === 0) {
                        roomList.push({
                            id: Number(roomData[0]),
                            host: roomData[1],
                            players: Number(roomData[4]),
                            max: Number(roomData[3])
                        });
                    }
                }
                setRooms(roomList);
            } catch (e) {
                console.error("Error fetching rooms:", e);
            } finally {
                setIsLoading(false);
            }
        };

        fetchRooms();
    }, [publicClient]);

    const handleJoin = async (roomId: number) => {
        await joinLobbyOnChain(roomId);
        setLobbyName(`Room #${roomId}`);
        navigate('/lobby');
    };

    return (
        <div className="relative w-full min-h-screen font-['Montserrat'] flex items-center justify-center p-4">
            <div className="fixed inset-0 z-0 bg-cover bg-center" style={{ backgroundImage: `url(${lobbyBg})` }}>
                <div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" />
            </div>

            <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} className="relative z-10 w-full max-w-[600px] flex flex-col items-center gap-6 py-10">
                <div className="w-full flex items-center justify-start"><BackButton /></div>
                <h2 className="text-white text-3xl font-light tracking-widest uppercase">Live Sessions</h2>

                <div className="w-full flex flex-col gap-3">
                    {isLoading ? (
                        <div className="text-white/40 text-center py-10">Scanning Somnia Network...</div>
                    ) : rooms.length === 0 ? (
                        <div className="text-white/40 text-center py-10 bg-black/20 rounded-2xl border border-white/5">
                            No active lobbies found. <br /> Be the first to create one!
                        </div>
                    ) : rooms.map((room) => (
                        <motion.button
                            key={room.id}
                            whileHover={{ scale: 1.02, backgroundColor: "rgba(145, 106, 71, 0.2)" }}
                            onClick={() => handleJoin(room.id)}
                            disabled={isTxPending}
                            className="w-full p-5 bg-[#19130D]/80 backdrop-blur-sm border border-white/10 rounded-[15px] flex items-center justify-between group transition-all"
                        >
                            <div className="flex flex-col items-start gap-1">
                                <span className="text-white text-lg font-medium">Room #{room.id}</span>
                                <span className="text-white/40 text-[10px] font-mono uppercase">{room.host.slice(0, 10)}...</span>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="text-right">
                                    <span className="text-[#916A47] font-bold block">{room.players}/{room.max}</span>
                                    <span className="text-white/20 text-[8px] uppercase tracking-wider">Players Joined</span>
                                </div>
                                <div className="w-8 h-8 rounded-full bg-[#916A47]/20 flex items-center justify-center text-[#916A47]">→</div>
                            </div>
                        </motion.button>
                    ))}
                </div>
            </motion.div>
        </div>
    );
};

==================================================
FILE PATH: components/lobby_flow/SetupProfile.tsx
==================================================
import React, { useRef } from 'react';
import { Camera, Upload } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import { useGameContext } from '../../contexts/GameContext';
import lobbyBg from '../../assets/lobby_background.png';
import { Button } from '../ui/Button';
import { Input } from '../ui/Input';

export const SetupProfile: React.FC = () => {
    const { playerName, setPlayerName, avatarUrl, setAvatarUrl } = useGameContext();
    const navigate = useNavigate();
    const fileInputRef = useRef<HTMLInputElement>(null);

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            const url = URL.createObjectURL(file);
            setAvatarUrl(url);
        }
    };

    return (
        <div className="relative w-full min-h-screen font-['Montserrat'] flex items-center justify-center p-4">
            {/* Fixed Background */}
            <div className="fixed inset-0 z-0 bg-cover bg-center bg-no-repeat"
                style={{ backgroundImage: `url(${lobbyBg})` }}
            >
                <div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" />
            </div>

            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.4 }}
                className="relative z-10 w-full max-w-[600px] flex flex-col items-center gap-8 py-10"
            >
                {/* Profile Section */}
                <div className="w-full bg-[rgba(40,22,8,0.70)] backdrop-blur-md rounded-[42px] relative flex flex-col items-center p-8 border border-white/10 shadow-2xl">
                    <h2 className="text-white/60 text-lg font-['Montserrat'] italic mb-6">Setup Your Profile</h2>

                    {/* Photo Input */}
                    <div
                        className="relative group cursor-pointer mb-6"
                        onClick={() => fileInputRef.current?.click()}
                    >
                        <div className="w-[150px] h-[150px] rounded-full border-2 border-[#916A47] shadow-xl overflow-hidden flex items-center justify-center bg-[#19130D] transition-transform group-hover:scale-105">
                            {avatarUrl ? (
                                <img src={avatarUrl} alt="Avatar" className="w-full h-full object-cover" />
                            ) : (
                                <Camera className="w-12 h-12 text-white/20 group-hover:text-white/50 transition-colors" />
                            )}
                        </div>
                        <div className="absolute inset-0 rounded-full bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <Upload className="w-8 h-8 text-white" />
                        </div>
                        <input
                            type="file"
                            ref={fileInputRef}
                            className="hidden"
                            accept="image/*"
                            onChange={handleFileChange}
                        />
                    </div>

                    {/* Name Input */}
                    <div className="w-full max-w-[300px] flex flex-col items-center gap-2">
                        <label className="text-white/40 text-sm font-['Montserrat'] italic">Enter Name</label>
                        <Input
                            value={playerName}
                            onChange={(e) => setPlayerName(e.target.value)}
                            placeholder="Your Name"
                            containerClassName="w-full"
                            className="!font-['Montserrat']"
                        />
                    </div>
                </div>

                {/* Actions */}
                <div className="w-full flex flex-col gap-4">
                    <Button
                        onClick={() => navigate('/create')}
                        disabled={!playerName.trim()}
                        className="w-full h-[60px] text-xl"
                    >
                        Create Game
                    </Button>
                    <Button
                        onClick={() => navigate('/join')}
                        disabled={!playerName.trim()}
                        variant="outline-gold"
                        className="w-full h-[60px] text-xl"
                    >
                        Connect to Lobby
                    </Button>
                </div>
            </motion.div>
        </div>
    );
};


==================================================
FILE PATH: components/lobby_flow/WaitingRoom.tsx
==================================================
import React, { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import { useGameContext } from '../../contexts/GameContext';
import lobbyBg from '../../assets/lobby_background.png';
import { Button } from '../ui/Button';
import { BackButton } from '../ui/BackButton';
import { GamePhase } from '../../types';

export const WaitingRoom: React.FC = () => {
    const {
        lobbyName,
        gameState,
        startGameOnChain,
        isTxPending,
        currentRoomId,
        myPlayer
    } = useGameContext();

    const navigate = useNavigate();

    // 1. Авто-переход при смене фазы в блокчейне
    useEffect(() => {
        if (gameState.phase === GamePhase.SHUFFLING || gameState.phase === GamePhase.ROLE_REVEAL) {
            navigate('/game');
        }
    }, [gameState.phase, navigate]);

    // 2. Логика Хоста: Хост тот, чей адрес совпадает с полем host в первой комнате 
    // или просто первый игрок в списке (как в нашем контракте)
    const isHost = gameState.players[0]?.address.toLowerCase() === myPlayer?.address.toLowerCase();

    const handleStart = async () => {
        if (isTxPending) return;
        await startGameOnChain();
    };

    return (
        <div className="relative w-full min-h-screen font-['Montserrat'] flex items-center justify-center p-4">
            <div className="fixed inset-0 z-0 bg-cover bg-center bg-no-repeat"
                style={{ backgroundImage: `url(${lobbyBg})` }}
            >
                <div className="absolute inset-0 bg-black/40 backdrop-blur-[2px]" />
            </div>

            <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                className="relative z-10 w-full max-w-[600px] flex flex-col items-center gap-6 py-10 mt-16"
            >
                <div className="w-full flex items-center justify-start">
                    <BackButton to="/setup" label="Exit to Menu" />
                </div>

                <div className="flex flex-col items-center text-center">
                    <p className="text-[#916A47] text-[10px] uppercase tracking-[0.3em] font-bold mb-2">
                        Somnia Session #{currentRoomId?.toString() || '...'}
                    </p>
                    <h1 className="text-white text-3xl font-light tracking-widest uppercase">
                        {lobbyName || 'Game Lobby'}
                    </h1>
                    <div className="flex items-center gap-2 mt-2">
                        <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
                        <span className="text-white/40 text-xs uppercase tracking-widest">
                            Syncing with Smart Contract...
                        </span>
                    </div>
                </div>

                <div className="w-full bg-[rgba(15,10,5,0.85)] backdrop-blur-xl rounded-[32px] p-6 border border-white/5 shadow-2xl flex flex-col">
                    <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-3 min-h-[300px] max-h-[400px]">
                        {gameState.players.map((player, index) => {
                            const isMe = player.address.toLowerCase() === myPlayer?.address.toLowerCase();

                            return (
                                <motion.div
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    key={player.address}
                                    className={`w-full p-4 rounded-2xl flex justify-between items-center border transition-all ${isMe ? 'bg-[#916A47]/10 border-[#916A47]/30' : 'bg-white/[0.02] border-white/5'
                                        }`}
                                >
                                    <div className="flex items-center gap-4">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold ${isMe ? 'bg-[#916A47] text-black' : 'bg-white/5 text-white/40'
                                            }`}>
                                            {index + 1}
                                        </div>
                                        <div className="flex flex-col">
                                            <span className={`font-medium ${isMe ? 'text-[#916A47]' : 'text-white'}`}>
                                                {player.name} {isMe && '(You)'}
                                            </span>
                                            <span className="text-[10px] font-mono text-white/20">
                                                {player.address.slice(0, 6)}...{player.address.slice(-4)}
                                            </span>
                                        </div>
                                    </div>
                                    {index === 0 && (
                                        <span className="text-[9px] bg-[#916A47]/20 text-[#916A47] px-2 py-1 rounded border border-[#916A47]/30 uppercase font-bold">
                                            Host
                                        </span>
                                    )}
                                </motion.div>
                            );
                        })}

                        {gameState.players.length === 0 && !isTxPending && (
                            <div className="py-20 text-center text-white/20 italic">
                                Connecting to network...
                            </div>
                        )}
                    </div>

                    <div className="pt-4 mt-4 border-t border-white/5 flex items-center justify-between">
                        <div className="text-white/40 text-[10px] uppercase tracking-tighter font-mono">
                            Status: Secured by ZK-Shuffle
                        </div>
                        <div className="text-white/60 text-sm">
                            Players: <span className="text-[#916A47] font-bold">{gameState.players.length}/16</span>
                        </div>
                    </div>
                </div>

                {isHost ? (
                    <Button
                        onClick={handleStart}
                        isLoading={isTxPending}
                        disabled={isTxPending || gameState.players.length < 2} // Для теста 2, в идеале 4
                        className="w-full h-[70px] text-xl tracking-widest uppercase shadow-[0_10px_40px_rgba(145,106,71,0.2)]"
                    >
                        {isTxPending ? "Starting..." : "Start Game"}
                    </Button>
                ) : (
                    <div className="w-full p-6 rounded-2xl bg-white/[0.02] border border-white/5 text-center backdrop-blur-sm">
                        <p className="text-white/30 text-sm italic">
                            Waiting for the Host to start the transaction...
                        </p>
                    </div>
                )}
            </motion.div>
        </div>
    );
};

==================================================
FILE PATH: components/ui/BackButton.tsx
==================================================
import React from 'react';
import { ArrowLeft } from 'lucide-react';
import { useNavigate } from 'react-router-dom';

interface BackButtonProps {
    to?: string; // If not provided, goes back in history
    label?: string;
    className?: string;
}

export const BackButton: React.FC<BackButtonProps> = ({ to, label = "Back", className = "" }) => {
    const navigate = useNavigate();

    const handleClick = () => {
        if (to) {
            navigate(to);
        } else {
            navigate(-1);
        }
    };

    return (
        <button
            onClick={handleClick}
            className={`text-white/60 hover:text-white flex items-center gap-2 transition-colors ${className}`}
        >
            <ArrowLeft className="w-5 h-5" />
            <span>{label}</span>
        </button>
    );
};


==================================================
FILE PATH: components/ui/Button.tsx
==================================================
import React from 'react';
import { motion } from 'framer-motion';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
    variant?: 'primary' | 'secondary' | 'outline-gold' | 'ghost';
    isLoading?: boolean;
}

export const Button: React.FC<ButtonProps> = ({
    children,
    className = "",
    variant = 'primary',
    isLoading,
    disabled,
    ...props
}) => {

    const baseStyles = "relative flex items-center justify-center font-[Montserrat] font-medium transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:active:scale-100";

    const variants = {
        primary: "bg-[#916A47] hover:bg-[#a37a55] text-white shadow-lg border border-white/10 rounded-[15px]",
        secondary: "bg-[#19130D] hover:bg-[#2a2118] text-white/80 border border-white/5 rounded-[15px]",
        'outline-gold': "bg-transparent border-2 border-[#916A47] text-[#916A47] hover:bg-[#916A47] hover:text-[#281608] rounded-[15px] box-border",
        ghost: "bg-transparent text-white/60 hover:text-white"
    };

    return (
        <motion.button
            whileTap={{ scale: disabled ? 1 : 0.98 }}
            className={`${baseStyles} ${variants[variant]} ${className}`}
            disabled={disabled || isLoading}
            {...(props as any)}
        >
            {isLoading ? (
                <span className="w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin" />
            ) : children}
        </motion.button>
    );
};


==================================================
FILE PATH: components/ui/Input.tsx
==================================================
import React from 'react';

interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
    label?: string;
    containerClassName?: string;
}

export const Input: React.FC<InputProps> = ({
    label,
    className = "",
    containerClassName = "",
    ...props
}) => {
    return (
        <div className={`flex flex-col gap-2 ${containerClassName}`}>
            {label && (
                <label className="text-white/40 text-sm font-['Playfair_Display'] italic">
                    {label}
                </label>
            )}
            <input
                className={`w-full h-[50px] bg-[#19130D]/60 rounded-[10px] border border-white/10 text-center text-white text-xl placeholder:text-white/20 focus:outline-none focus:border-[#916A47] transition-all font-['Playfair_Display'] ${className}`}
                {...props}
            />
        </div>
    );
};


==================================================
FILE PATH: contexts/GameContext.tsx
==================================================
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { useAccount, useWriteContract, usePublicClient, useWatchContractEvent } from 'wagmi';
import { GamePhase, GameState, Player, Role, LogEntry } from '../types';
import { MAFIA_CONTRACT_ADDRESS, MAFIA_ABI } from '../contracts/config';
import { generateKeyPair, exportPublicKey } from '../services/cryptoUtils';

interface GameContextType {
    playerName: string;
    setPlayerName: (name: string) => void;
    avatarUrl: string | null;
    setAvatarUrl: (url: string | null) => void;
    lobbyName: string;
    setLobbyName: (name: string) => void;
    gameState: GameState;
    setGameState: React.Dispatch<React.SetStateAction<GameState>>;
    isTxPending: boolean;
    currentRoomId: bigint | null;

    createLobbyOnChain: () => Promise<void>;
    joinLobbyOnChain: (roomId: number) => Promise<void>;
    startGameOnChain: () => Promise<void>;
    confirmRoleOnChain: () => Promise<void>;

    handleNextPhase: () => void;
    addLog: (message: string, type?: LogEntry['type']) => void;
    handlePlayerAction: (targetId: string) => void;
    myPlayer: Player | undefined;
    getActionLabel: () => string;
    canActOnPlayer: (target: Player) => boolean;
}

const GameContext = createContext<GameContextType | undefined>(undefined);

export const GameProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
    const [playerName, setPlayerName] = useState('');
    const [avatarUrl, setAvatarUrl] = useState<string | null>(null);
    const [lobbyName, setLobbyName] = useState('');
    const [currentRoomId, setCurrentRoomId] = useState<bigint | null>(null);
    const [keys, setKeys] = useState<CryptoKeyPair | null>(null);

    const { address } = useAccount();
    const { writeContractAsync } = useWriteContract();
    const publicClient = usePublicClient();
    const [isTxPending, setIsTxPending] = useState(false);

    const [gameState, setGameState] = useState<GameState>({
        phase: GamePhase.LOBBY,
        dayCount: 0,
        players: [],
        myPlayerId: null,
        logs: [],
        winner: null
    });

    // Синхронизируем myPlayerId с адресом кошелька
    useEffect(() => {
        if (address) {
            setGameState(prev => ({ ...prev, myPlayerId: address }));
        }
    }, [address]);

    const addLog = (message: string, type: LogEntry['type'] = 'info') => {
        const now = new Date();
        const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        setGameState(prev => ({
            ...prev,
            logs: [...prev.logs, { id: Math.random().toString(36).substr(2, 9), timestamp: timeString, message, type }]
        }));
    };

    // Вспомогательная функция для обновления списка игроков из блокчейна
    const refreshPlayersList = async (roomId: bigint) => {
        if (!publicClient) return;
        try {
            const data = await publicClient.readContract({
                address: MAFIA_CONTRACT_ADDRESS,
                abi: MAFIA_ABI,
                functionName: 'getPlayers',
                args: [roomId],
            }) as any[];

            const formattedPlayers: Player[] = data.map((p: any) => ({
                id: p.wallet,
                name: p.nickname,
                address: p.wallet,
                role: Role.UNKNOWN,
                isAlive: true,
                avatarUrl: `https://picsum.photos/seed/${p.wallet}/200`,
                votesReceived: 0,
                status: 'connected'
            }));

            setGameState(prev => ({ ...prev, players: formattedPlayers }));
        } catch (e) {
            console.error("Failed to fetch players:", e);
        }
    };

    // 1. Создать Лобби
    const createLobbyOnChain = async () => {
        if (!playerName) return alert("Please set your name in Profile first!");
        setIsTxPending(true);
        try {
            const keyPair = await generateKeyPair();
            setKeys(keyPair);
            const pubKey = await exportPublicKey(keyPair.publicKey);

            const hash = await writeContractAsync({
                address: MAFIA_CONTRACT_ADDRESS,
                abi: MAFIA_ABI,
                functionName: 'createRoom',
                args: [BigInt(16), playerName, pubKey],
            });
            addLog("Creating room on Somnia...", "warning");
            await publicClient?.waitForTransactionReceipt({ hash });
        } catch (e: any) {
            addLog(e.message, "danger");
            setIsTxPending(false);
        }
    };

    // 2. Войти в Лобби
    const joinLobbyOnChain = async (roomId: number) => {
        if (!playerName) return alert("Please set your name in Profile first!");
        setIsTxPending(true);
        try {
            const keyPair = await generateKeyPair();
            setKeys(keyPair);
            const pubKey = await exportPublicKey(keyPair.publicKey);

            const hash = await writeContractAsync({
                address: MAFIA_CONTRACT_ADDRESS,
                abi: MAFIA_ABI,
                functionName: 'joinRoom',
                args: [BigInt(roomId), playerName, pubKey],
            });
            setCurrentRoomId(BigInt(roomId));
            addLog(`Joining room #${roomId}...`, "info");
            await publicClient?.waitForTransactionReceipt({ hash });

            // Сразу подгружаем список тех, кто уже в комнате
            await refreshPlayersList(BigInt(roomId));
        } catch (e: any) {
            addLog(e.message, "danger");
            setIsTxPending(false);
        }
    };

    // 3. Старт игры (только хост)
    const startGameOnChain = async () => {
        if (!currentRoomId) return;
        setIsTxPending(true);
        try {
            const hash = await writeContractAsync({
                address: MAFIA_CONTRACT_ADDRESS,
                abi: MAFIA_ABI,
                functionName: 'startShuffle',
                args: [currentRoomId],
            });
            addLog("Initiating on-chain shuffle...", "phase");
            await publicClient?.waitForTransactionReceipt({ hash });
        } catch (e: any) {
            addLog(e.message, "danger");
            setIsTxPending(false);
        }
    };

    const confirmRoleOnChain = async () => {
        if (!currentRoomId) return;
        setIsTxPending(true);
        try {
            const hash = await writeContractAsync({
                address: MAFIA_CONTRACT_ADDRESS,
                abi: MAFIA_ABI,
                functionName: 'confirmRole',
                args: [currentRoomId],
            });
            await publicClient?.waitForTransactionReceipt({ hash });
        } catch (e: any) {
            addLog(e.message, "danger");
            setIsTxPending(false);
        }
    };

    // --- СЛУШАТЕЛИ СОБЫТИЙ (Real-time Sync) ---

    useWatchContractEvent({
        address: MAFIA_CONTRACT_ADDRESS,
        abi: MAFIA_ABI,
        eventName: 'RoomCreated',
        onLogs(logs: any) {
            const log = logs[0];
            if (log.args.host.toLowerCase() === address?.toLowerCase()) {
                const newId = log.args.roomId;
                setCurrentRoomId(newId);
                setIsTxPending(false);
                addLog(`Room #${newId} created successfully!`, "success");
                refreshPlayersList(newId);
            }
        }
    });

    useWatchContractEvent({
        address: MAFIA_CONTRACT_ADDRESS,
        abi: MAFIA_ABI,
        eventName: 'PlayerJoined',
        onLogs(logs: any) {
            logs.forEach((log: any) => {
                if (currentRoomId && BigInt(log.args.roomId) === currentRoomId) {
                    addLog(`${log.args.nickname} joined the room.`, "info");
                    refreshPlayersList(currentRoomId); // Перечитываем список при каждом входе
                }
            });
        }
    });

    useWatchContractEvent({
        address: MAFIA_CONTRACT_ADDRESS,
        abi: MAFIA_ABI,
        eventName: 'GameStarted',
        onLogs(logs: any) {
            if (currentRoomId && BigInt(logs[0].args.roomId) === currentRoomId) {
                setGameState(prev => ({ ...prev, phase: GamePhase.SHUFFLING }));
                setIsTxPending(false);
                addLog("Shuffle started! Check your roles soon...", "phase");
            }
        }
    });

    useWatchContractEvent({
        address: MAFIA_CONTRACT_ADDRESS,
        abi: MAFIA_ABI,
        eventName: 'DayStarted',
        onLogs(logs: any) {
            if (currentRoomId && BigInt(logs[0].args.roomId) === currentRoomId) {
                setGameState(prev => ({
                    ...prev,
                    phase: GamePhase.DAY,
                    dayCount: Number(logs[0].args.dayNumber)
                }));
                addLog(`Day ${logs[0].args.dayNumber} has begun.`, "success");
            }
        }
    });

    // --- UI HELPERS ---

    const handlePlayerAction = (id: string) => {
        addLog(`Action targeted at: ${id.slice(0, 6)}...`, "info");
    };

    const handleNextPhase = () => {
        // В будущем это будет вызов контракта, пока оставим локально для тестов UI
        addLog("Dev: Manual phase shift", "warning");
    };

    const myPlayer = gameState.players.find(p => p.address.toLowerCase() === address?.toLowerCase());

    const getActionLabel = () => {
        if (gameState.phase === GamePhase.VOTING) return "VOTE";
        if (myPlayer?.role === Role.MAFIA) return "KILL";
        return "SELECT";
    };

    const canActOnPlayer = (_target: Player) => {
        return gameState.phase !== GamePhase.LOBBY;
    };

    return (
        <GameContext.Provider value={{
            playerName, setPlayerName, avatarUrl, setAvatarUrl, lobbyName, setLobbyName,
            gameState, setGameState, isTxPending, currentRoomId,
            createLobbyOnChain, joinLobbyOnChain, startGameOnChain, confirmRoleOnChain,
            addLog, handlePlayerAction, handleNextPhase, myPlayer, canActOnPlayer, getActionLabel
        }}>
            {children}
        </GameContext.Provider>
    );
};

export const useGameContext = () => {
    const context = useContext(GameContext);
    if (!context) throw new Error("useGameContext must be used within a GameProvider");
    return context;
};

==================================================
FILE PATH: contracts/MafiaPortal.json
==================================================
{
  "_format": "hh3-artifact-1",
  "contractName": "MafiaPortal",
  "sourceName": "contracts/MafiaPortal.sol",
  "abi": [
    {
      "inputs": [],
      "name": "AlreadyJoined",
      "type": "error"
    },
    {
      "inputs": [],
      "name": "NotHost",
      "type": "error"
    },
    {
      "inputs": [],
      "name": "RoomNotFound",
      "type": "error"
    },
    {
      "inputs": [],
      "name": "WrongPhase",
      "type": "error"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "roomId",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "dayNumber",
          "type": "uint256"
        }
      ],
      "name": "DayStarted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "roomId",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "byPlayer",
          "type": "address"
        }
      ],
      "name": "DeckSubmitted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "roomId",
          "type": "uint256"
        }
      ],
      "name": "GameStarted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "roomId",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "encryptedKey",
          "type": "string"
        }
      ],
      "name": "KeyShared",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "roomId",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "player",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "nickname",
          "type": "string"
        }
      ],
      "name": "PlayerJoined",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "roomId",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "player",
          "type": "address"
        }
      ],
      "name": "RoleConfirmed",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "roomId",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "host",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "maxPlayers",
          "type": "uint256"
        }
      ],
      "name": "RoomCreated",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_roomId",
          "type": "uint256"
        }
      ],
      "name": "confirmRole",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_maxPlayers",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_hostNickname",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_publicKey",
          "type": "string"
        }
      ],
      "name": "createRoom",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_roomId",
          "type": "uint256"
        }
      ],
      "name": "getDeck",
      "outputs": [
        {
          "internalType": "string[]",
          "name": "",
          "type": "string[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_roomId",
          "type": "uint256"
        }
      ],
      "name": "getMyKey",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_roomId",
          "type": "uint256"
        }
      ],
      "name": "getPlayers",
      "outputs": [
        {
          "components": [
            {
              "internalType": "address",
              "name": "wallet",
              "type": "address"
            },
            {
              "internalType": "string",
              "name": "nickname",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "publicKey",
              "type": "string"
            },
            {
              "internalType": "bool",
              "name": "hasConfirmedRole",
              "type": "bool"
            }
          ],
          "internalType": "struct MafiaPortal.Player[]",
          "name": "",
          "type": "tuple[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_roomId",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_nickname",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_publicKey",
          "type": "string"
        }
      ],
      "name": "joinRoom",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "keyMailbox",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "nextRoomId",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "roomDeck",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "roomPlayers",
      "outputs": [
        {
          "internalType": "address",
          "name": "wallet",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "nickname",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "publicKey",
          "type": "string"
        },
        {
          "internalType": "bool",
          "name": "hasConfirmedRole",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "rooms",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "host",
          "type": "address"
        },
        {
          "internalType": "enum MafiaPortal.GamePhase",
          "name": "phase",
          "type": "uint8"
        },
        {
          "internalType": "uint256",
          "name": "maxPlayers",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "playersCount",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "dayCount",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_roomId",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "_to",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "_encryptedKey",
          "type": "string"
        }
      ],
      "name": "shareKey",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_roomId",
          "type": "uint256"
        }
      ],
      "name": "startShuffle",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_roomId",
          "type": "uint256"
        },
        {
          "internalType": "string[]",
          "name": "_deck",
          "type": "string[]"
        }
      ],
      "name": "submitDeck",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ],
  "bytecode": "0x608060405260016004553480156013575f5ffd5b5061195c806100215f395ff3fe608060405234801561000f575f5ffd5b50600436106100e5575f3560e01c80635099fae211610088578063c21a2ae611610063578063c21a2ae614610236578063c4e4a68e14610249578063d275ecbf1461025c578063f4e887c01461026f575f5ffd5b80635099fae2146101fd5780636b41f5f3146102105780637fcd07d114610223575f5ffd5b8063139db82d116100c3578063139db82d146101485780631bae0ac81461015d5780632a51fb3a146101bd578063460e2049146101dd575f5ffd5b806307a52cab146100e957806309ed3e22146101055780630f8d2b6814610128575b5f5ffd5b6100f260045481565b6040519081526020015b60405180910390f35b6101186101133660046111b1565b610282565b6040516100fc94939291906111ff565b61013b6101363660046111b1565b6103e1565b6040516100fc9190611248565b61015b6101563660046112a6565b610492565b005b6101ab61016b3660046113da565b5f602081905290815260409020805460018201546002830154600384015460049094015492936001600160a01b03831693600160a01b90930460ff169286565b6040516100fc96959493929190611405565b6101d06101cb3660046113da565b610536565b6040516100fc919061145a565b6101f06101eb3660046113da565b61061b565b6040516100fc91906114bd565b61015b61020b3660046113da565b6107c6565b61015b61021e3660046115a2565b6109f6565b61015b6102313660046115a2565b610cb7565b61013b610244366004611636565b610ef6565b61015b610257366004611660565b610f19565b61015b61026a3660046113da565b610f7a565b61013b61027d3660046113da565b611049565b6001602052815f5260405f20818154811061029b575f80fd5b5f918252602090912060049091020180546001820180546001600160a01b0390921694509192506102cb906116b6565b80601f01602080910402602001604051908101604052809291908181526020018280546102f7906116b6565b80156103425780601f1061031957610100808354040283529160200191610342565b820191905f5260205f20905b81548152906001019060200180831161032557829003601f168201915b505050505090806002018054610357906116b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610383906116b6565b80156103ce5780601f106103a5576101008083540402835291602001916103ce565b820191905f5260205f20905b8154815290600101906020018083116103b157829003601f168201915b5050506003909301549192505060ff1684565b6002602052815f5260405f2081815481106103fa575f80fd5b905f5260205f20015f91509150508054610413906116b6565b80601f016020809104026020016040519081016040528092919081815260200182805461043f906116b6565b801561048a5780601f106104615761010080835404028352916020019161048a565b820191905f5260205f20905b81548152906001019060200180831161046d57829003601f168201915b505050505081565b60015f83815260208190526040902060010154600160a01b900460ff1660068111156104c0576104c06113f1565b146104de576040516338961af360e21b815260040160405180910390fd5b5f82815260026020908152604090912082516104fc928401906110f3565b5060405133815282907f1627cc2f10026e05e217e1f88254e0ca2a3a56b51beb97ddd134e329d1dea0fc9060200160405180910390a25050565b606060025f8381526020019081526020015f20805480602002602001604051908101604052809291908181526020015f905b82821015610610578382905f5260205f20018054610585906116b6565b80601f01602080910402602001604051908101604052809291908181526020018280546105b1906116b6565b80156105fc5780601f106105d3576101008083540402835291602001916105fc565b820191905f5260205f20905b8154815290600101906020018083116105df57829003601f168201915b505050505081526020019060010190610568565b505050509050919050565b606060015f8381526020019081526020015f20805480602002602001604051908101604052809291908181526020015f905b82821015610610575f84815260209081902060408051608081019091526004850290910180546001600160a01b031682526001810180549293919291840191610695906116b6565b80601f01602080910402602001604051908101604052809291908181526020018280546106c1906116b6565b801561070c5780601f106106e35761010080835404028352916020019161070c565b820191905f5260205f20905b8154815290600101906020018083116106ef57829003601f168201915b50505050508152602001600282018054610725906116b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610751906116b6565b801561079c5780601f106107735761010080835404028352916020019161079c565b820191905f5260205f20905b81548152906001019060200180831161077f57829003601f168201915b50505091835250506003919091015460ff161515602091820152908252600192909201910161064d565b5f8181526001602052604081209080805b835481101561093b57336001600160a01b03168482815481106107fc576107fc6116ee565b5f9182526020909120600490910201546001600160a01b0316036108f85783818154811061082c5761082c6116ee565b5f91825260209091206003600490920201015460ff16156108885760405162461bcd60e51b8152602060048201526011602482015270105b1c9958591e4818dbdb999a5c9b5959607a1b60448201526064015b60405180910390fd5b600184828154811061089c5761089c6116ee565b5f91825260209182902060049190910201600301805460ff1916921515929092179091556040513381526001935086917f82b52ddf0195aa8ac16480985f5042052aa742563721520fa34764d253824d43910160405180910390a25b83818154811061090a5761090a6116ee565b5f91825260209091206003600490920201015460ff1615610933578261092f81611702565b9350505b6001016107d7565b50806109785760405162461bcd60e51b815260206004820152600c60248201526b2737ba103090383630bcb2b960a11b604482015260640161087f565b5f8481526020819052604090206003015482036109f0575f84815260208181526040918290206001808201805460ff60a01b1916600360a01b1790556004909101819055915191825285917fa9b4e96158ed085745975f198fa026959997245ae7e7aed9cd0252ce02b2107191015b60405180910390a25b50505050565b841580610a0557506004548510155b15610a2357604051637954354d60e11b815260040160405180910390fd5b5f858152602081905260408120906001820154600160a01b900460ff166006811115610a5157610a516113f1565b14610a955760405162461bcd60e51b815260206004820152601460248201527311d85b5948185b1c9958591e481cdd185c9d195960621b604482015260640161087f565b8060020154816003015410610adb5760405162461bcd60e51b815260206004820152600c60248201526b149bdbdb481a5cc8199d5b1b60a21b604482015260640161087f565b5f868152600160205260408120905b8154811015610b4d57336001600160a01b0316828281548110610b0f57610b0f6116ee565b5f9182526020909120600490910201546001600160a01b031603610b4557604051621d934160e11b815260040160405180910390fd5b600101610aea565b50806040518060800160405280336001600160a01b0316815260200188888080601f0160208091040260200160405190810160405280939291908181526020018383808284375f92019190915250505090825250604080516020601f8901819004810282018101909252878152918101919088908890819084018382808284375f920182905250938552505050602091820181905283546001808201865594825290829020835160049092020180546001600160a01b0319166001600160a01b03909216919091178155908201519192909190820190610c2d9082611772565b5060408201516002820190610c429082611772565b50606091909101516003918201805460ff191691151591909117905582018054905f610c6d83611702565b9190505550867fa259bab503f65f6ae62d4f6a412b41b967799a284f69f21ba61362cf04e5eafa338888604051610ca69392919061182d565b60405180910390a250505050505050565b60028510158015610cc9575060108511155b610d0c5760405162461bcd60e51b8152602060048201526014602482015273125b9d985b1a59081c1b185e595c8818dbdd5b9d60621b604482015260640161087f565b600480545f81815260208181526040808320938455600180850180546001600160a81b03191660ff60a01b193390811691909117909155600286018c90558587018590559554845282529182902082516080810184529485528251601f89018390048302810183019093528783529293918282019189908990819084018382808284375f92019190915250505090825250604080516020601f8801819004810282018101909252868152918101919087908790819084018382808284375f920182905250938552505050602091820181905283546001808201865594825290829020835160049092020180546001600160a01b0319166001600160a01b03909216919091178155908201519192909190820190610e299082611772565b5060408201516002820190610e3e9082611772565b50606091909101516003918201805460ff191691151591909117905560019082015560045460408051338152602081018990527fac131287fe8417903d89f4eb472bc1d0da81641ef725569346dab6c2879a6717910160405180910390a26004547fa259bab503f65f6ae62d4f6a412b41b967799a284f69f21ba61362cf04e5eafa338787604051610ed29392919061182d565b60405180910390a260048054905f610ee983611702565b9190505550505050505050565b600360209081525f928352604080842090915290825290208054610413906116b6565b5f8481526003602090815260408083206001600160a01b03871684529091529020610f4582848361186c565b50837fe4a7855f88ef0e52a4504a8ac826d16af53025ac471d92626f7ad77806ab78cb8484846040516109e79392919061182d565b5f818152602081905260409020600101546001600160a01b03163314610fb357604051638ff4f0c960e01b815260040160405180910390fd5b5f5f82815260208190526040902060010154600160a01b900460ff166006811115610fe057610fe06113f1565b14610ffe576040516338961af360e21b815260040160405180910390fd5b5f81815260208190526040808220600101805460ff60a01b1916600160a01b1790555182917f50ad08f58a27f2851d7e3a1b3a6a46b290f2ce677e99642d30ff639721e7779091a250565b5f8181526003602090815260408083203384529091529020805460609190611070906116b6565b80601f016020809104026020016040519081016040528092919081815260200182805461109c906116b6565b80156110e75780601f106110be576101008083540402835291602001916110e7565b820191905f5260205f20905b8154815290600101906020018083116110ca57829003601f168201915b50505050509050919050565b828054828255905f5260205f20908101928215611137579160200282015b8281111561113757825182906111279082611772565b5091602001919060010190611111565b50611143929150611147565b5090565b80821115611143575f61115a8282611163565b50600101611147565b50805461116f906116b6565b5f825580601f1061117e575050565b601f0160209004905f5260205f209081019061119a919061119d565b50565b5b80821115611143575f815560010161119e565b5f5f604083850312156111c2575f5ffd5b50508035926020909101359150565b5f81518084528060208401602086015e5f602082860101526020601f19601f83011685010191505092915050565b6001600160a01b03851681526080602082018190525f90611222908301866111d1565b828103604084015261123481866111d1565b915050821515606083015295945050505050565b602081525f61125a60208301846111d1565b9392505050565b634e487b7160e01b5f52604160045260245ffd5b604051601f8201601f1916810167ffffffffffffffff8111828210171561129e5761129e611261565b604052919050565b5f5f604083850312156112b7575f5ffd5b82359150602083013567ffffffffffffffff8111156112d4575f5ffd5b8301601f810185136112e4575f5ffd5b803567ffffffffffffffff8111156112fe576112fe611261565b8060051b61130e60208201611275565b91825260208184018101929081019088841115611329575f5ffd5b6020850192505b838310156113cb57823567ffffffffffffffff81111561134e575f5ffd5b8501603f81018a1361135e575f5ffd5b602081013567ffffffffffffffff81111561137b5761137b611261565b61138e601f8201601f1916602001611275565b8181526040838301018c10156113a2575f5ffd5b816040840160208301375f60208383010152808552505050602082019150602083019250611330565b80955050505050509250929050565b5f602082840312156113ea575f5ffd5b5035919050565b634e487b7160e01b5f52602160045260245ffd5b8681526001600160a01b038616602082015260c081016007861061143757634e487b7160e01b5f52602160045260245ffd5b8560408301528460608301528360808301528260a0830152979650505050505050565b5f602082016020835280845180835260408501915060408160051b8601019250602086015f5b828110156114b157603f1987860301845261149c8583516111d1565b94506020938401939190910190600101611480565b50929695505050505050565b5f602082016020835280845180835260408501915060408160051b8601019250602086015f5b828110156114b157868503603f19018452815180516001600160a01b0316865260208082015160809188018290529061151e908801826111d1565b90506040820151878203604089015261153782826111d1565b6060938401511515989093019790975250945060209384019391909101906001016114e3565b5f5f83601f84011261156d575f5ffd5b50813567ffffffffffffffff811115611584575f5ffd5b60208301915083602082850101111561159b575f5ffd5b9250929050565b5f5f5f5f5f606086880312156115b6575f5ffd5b85359450602086013567ffffffffffffffff8111156115d3575f5ffd5b6115df8882890161155d565b909550935050604086013567ffffffffffffffff8111156115fe575f5ffd5b61160a8882890161155d565b969995985093965092949392505050565b80356001600160a01b0381168114611631575f5ffd5b919050565b5f5f60408385031215611647575f5ffd5b823591506116576020840161161b565b90509250929050565b5f5f5f5f60608587031215611673575f5ffd5b843593506116836020860161161b565b9250604085013567ffffffffffffffff81111561169e575f5ffd5b6116aa8782880161155d565b95989497509550505050565b600181811c908216806116ca57607f821691505b6020821081036116e857634e487b7160e01b5f52602260045260245ffd5b50919050565b634e487b7160e01b5f52603260045260245ffd5b5f6001820161171f57634e487b7160e01b5f52601160045260245ffd5b5060010190565b601f82111561176d57805f5260205f20601f840160051c8101602085101561174b5750805b601f840160051c820191505b8181101561176a575f8155600101611757565b50505b505050565b815167ffffffffffffffff81111561178c5761178c611261565b6117a08161179a84546116b6565b84611726565b6020601f8211600181146117d2575f83156117bb5750848201515b5f19600385901b1c1916600184901b17845561176a565b5f84815260208120601f198516915b8281101561180157878501518255602094850194600190920191016117e1565b508482101561181e57868401515f19600387901b60f8161c191681555b50505050600190811b01905550565b6001600160a01b03841681526040602082018190528101829052818360608301375f818301606090810191909152601f909201601f1916010192915050565b67ffffffffffffffff83111561188457611884611261565b6118988361189283546116b6565b83611726565b5f601f8411600181146118c9575f85156118b25750838201355b5f19600387901b1c1916600186901b17835561176a565b5f83815260208120601f198716915b828110156118f857868501358255602094850194600190920191016118d8565b5086821015611914575f1960f88860031b161c19848701351681555b505060018560011b018355505050505056fea2646970667358221220a5d1d71a2b05e4b4547d4f81bdedb340ee5f4832d7ed42e7e477a9d0bd64228a64736f6c634300081c0033",
  "deployedBytecode": "0x608060405234801561000f575f5ffd5b50600436106100e5575f3560e01c80635099fae211610088578063c21a2ae611610063578063c21a2ae614610236578063c4e4a68e14610249578063d275ecbf1461025c578063f4e887c01461026f575f5ffd5b80635099fae2146101fd5780636b41f5f3146102105780637fcd07d114610223575f5ffd5b8063139db82d116100c3578063139db82d146101485780631bae0ac81461015d5780632a51fb3a146101bd578063460e2049146101dd575f5ffd5b806307a52cab146100e957806309ed3e22146101055780630f8d2b6814610128575b5f5ffd5b6100f260045481565b6040519081526020015b60405180910390f35b6101186101133660046111b1565b610282565b6040516100fc94939291906111ff565b61013b6101363660046111b1565b6103e1565b6040516100fc9190611248565b61015b6101563660046112a6565b610492565b005b6101ab61016b3660046113da565b5f602081905290815260409020805460018201546002830154600384015460049094015492936001600160a01b03831693600160a01b90930460ff169286565b6040516100fc96959493929190611405565b6101d06101cb3660046113da565b610536565b6040516100fc919061145a565b6101f06101eb3660046113da565b61061b565b6040516100fc91906114bd565b61015b61020b3660046113da565b6107c6565b61015b61021e3660046115a2565b6109f6565b61015b6102313660046115a2565b610cb7565b61013b610244366004611636565b610ef6565b61015b610257366004611660565b610f19565b61015b61026a3660046113da565b610f7a565b61013b61027d3660046113da565b611049565b6001602052815f5260405f20818154811061029b575f80fd5b5f918252602090912060049091020180546001820180546001600160a01b0390921694509192506102cb906116b6565b80601f01602080910402602001604051908101604052809291908181526020018280546102f7906116b6565b80156103425780601f1061031957610100808354040283529160200191610342565b820191905f5260205f20905b81548152906001019060200180831161032557829003601f168201915b505050505090806002018054610357906116b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610383906116b6565b80156103ce5780601f106103a5576101008083540402835291602001916103ce565b820191905f5260205f20905b8154815290600101906020018083116103b157829003601f168201915b5050506003909301549192505060ff1684565b6002602052815f5260405f2081815481106103fa575f80fd5b905f5260205f20015f91509150508054610413906116b6565b80601f016020809104026020016040519081016040528092919081815260200182805461043f906116b6565b801561048a5780601f106104615761010080835404028352916020019161048a565b820191905f5260205f20905b81548152906001019060200180831161046d57829003601f168201915b505050505081565b60015f83815260208190526040902060010154600160a01b900460ff1660068111156104c0576104c06113f1565b146104de576040516338961af360e21b815260040160405180910390fd5b5f82815260026020908152604090912082516104fc928401906110f3565b5060405133815282907f1627cc2f10026e05e217e1f88254e0ca2a3a56b51beb97ddd134e329d1dea0fc9060200160405180910390a25050565b606060025f8381526020019081526020015f20805480602002602001604051908101604052809291908181526020015f905b82821015610610578382905f5260205f20018054610585906116b6565b80601f01602080910402602001604051908101604052809291908181526020018280546105b1906116b6565b80156105fc5780601f106105d3576101008083540402835291602001916105fc565b820191905f5260205f20905b8154815290600101906020018083116105df57829003601f168201915b505050505081526020019060010190610568565b505050509050919050565b606060015f8381526020019081526020015f20805480602002602001604051908101604052809291908181526020015f905b82821015610610575f84815260209081902060408051608081019091526004850290910180546001600160a01b031682526001810180549293919291840191610695906116b6565b80601f01602080910402602001604051908101604052809291908181526020018280546106c1906116b6565b801561070c5780601f106106e35761010080835404028352916020019161070c565b820191905f5260205f20905b8154815290600101906020018083116106ef57829003601f168201915b50505050508152602001600282018054610725906116b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610751906116b6565b801561079c5780601f106107735761010080835404028352916020019161079c565b820191905f5260205f20905b81548152906001019060200180831161077f57829003601f168201915b50505091835250506003919091015460ff161515602091820152908252600192909201910161064d565b5f8181526001602052604081209080805b835481101561093b57336001600160a01b03168482815481106107fc576107fc6116ee565b5f9182526020909120600490910201546001600160a01b0316036108f85783818154811061082c5761082c6116ee565b5f91825260209091206003600490920201015460ff16156108885760405162461bcd60e51b8152602060048201526011602482015270105b1c9958591e4818dbdb999a5c9b5959607a1b60448201526064015b60405180910390fd5b600184828154811061089c5761089c6116ee565b5f91825260209182902060049190910201600301805460ff1916921515929092179091556040513381526001935086917f82b52ddf0195aa8ac16480985f5042052aa742563721520fa34764d253824d43910160405180910390a25b83818154811061090a5761090a6116ee565b5f91825260209091206003600490920201015460ff1615610933578261092f81611702565b9350505b6001016107d7565b50806109785760405162461bcd60e51b815260206004820152600c60248201526b2737ba103090383630bcb2b960a11b604482015260640161087f565b5f8481526020819052604090206003015482036109f0575f84815260208181526040918290206001808201805460ff60a01b1916600360a01b1790556004909101819055915191825285917fa9b4e96158ed085745975f198fa026959997245ae7e7aed9cd0252ce02b2107191015b60405180910390a25b50505050565b841580610a0557506004548510155b15610a2357604051637954354d60e11b815260040160405180910390fd5b5f858152602081905260408120906001820154600160a01b900460ff166006811115610a5157610a516113f1565b14610a955760405162461bcd60e51b815260206004820152601460248201527311d85b5948185b1c9958591e481cdd185c9d195960621b604482015260640161087f565b8060020154816003015410610adb5760405162461bcd60e51b815260206004820152600c60248201526b149bdbdb481a5cc8199d5b1b60a21b604482015260640161087f565b5f868152600160205260408120905b8154811015610b4d57336001600160a01b0316828281548110610b0f57610b0f6116ee565b5f9182526020909120600490910201546001600160a01b031603610b4557604051621d934160e11b815260040160405180910390fd5b600101610aea565b50806040518060800160405280336001600160a01b0316815260200188888080601f0160208091040260200160405190810160405280939291908181526020018383808284375f92019190915250505090825250604080516020601f8901819004810282018101909252878152918101919088908890819084018382808284375f920182905250938552505050602091820181905283546001808201865594825290829020835160049092020180546001600160a01b0319166001600160a01b03909216919091178155908201519192909190820190610c2d9082611772565b5060408201516002820190610c429082611772565b50606091909101516003918201805460ff191691151591909117905582018054905f610c6d83611702565b9190505550867fa259bab503f65f6ae62d4f6a412b41b967799a284f69f21ba61362cf04e5eafa338888604051610ca69392919061182d565b60405180910390a250505050505050565b60028510158015610cc9575060108511155b610d0c5760405162461bcd60e51b8152602060048201526014602482015273125b9d985b1a59081c1b185e595c8818dbdd5b9d60621b604482015260640161087f565b600480545f81815260208181526040808320938455600180850180546001600160a81b03191660ff60a01b193390811691909117909155600286018c90558587018590559554845282529182902082516080810184529485528251601f89018390048302810183019093528783529293918282019189908990819084018382808284375f92019190915250505090825250604080516020601f8801819004810282018101909252868152918101919087908790819084018382808284375f920182905250938552505050602091820181905283546001808201865594825290829020835160049092020180546001600160a01b0319166001600160a01b03909216919091178155908201519192909190820190610e299082611772565b5060408201516002820190610e3e9082611772565b50606091909101516003918201805460ff191691151591909117905560019082015560045460408051338152602081018990527fac131287fe8417903d89f4eb472bc1d0da81641ef725569346dab6c2879a6717910160405180910390a26004547fa259bab503f65f6ae62d4f6a412b41b967799a284f69f21ba61362cf04e5eafa338787604051610ed29392919061182d565b60405180910390a260048054905f610ee983611702565b9190505550505050505050565b600360209081525f928352604080842090915290825290208054610413906116b6565b5f8481526003602090815260408083206001600160a01b03871684529091529020610f4582848361186c565b50837fe4a7855f88ef0e52a4504a8ac826d16af53025ac471d92626f7ad77806ab78cb8484846040516109e79392919061182d565b5f818152602081905260409020600101546001600160a01b03163314610fb357604051638ff4f0c960e01b815260040160405180910390fd5b5f5f82815260208190526040902060010154600160a01b900460ff166006811115610fe057610fe06113f1565b14610ffe576040516338961af360e21b815260040160405180910390fd5b5f81815260208190526040808220600101805460ff60a01b1916600160a01b1790555182917f50ad08f58a27f2851d7e3a1b3a6a46b290f2ce677e99642d30ff639721e7779091a250565b5f8181526003602090815260408083203384529091529020805460609190611070906116b6565b80601f016020809104026020016040519081016040528092919081815260200182805461109c906116b6565b80156110e75780601f106110be576101008083540402835291602001916110e7565b820191905f5260205f20905b8154815290600101906020018083116110ca57829003601f168201915b50505050509050919050565b828054828255905f5260205f20908101928215611137579160200282015b8281111561113757825182906111279082611772565b5091602001919060010190611111565b50611143929150611147565b5090565b80821115611143575f61115a8282611163565b50600101611147565b50805461116f906116b6565b5f825580601f1061117e575050565b601f0160209004905f5260205f209081019061119a919061119d565b50565b5b80821115611143575f815560010161119e565b5f5f604083850312156111c2575f5ffd5b50508035926020909101359150565b5f81518084528060208401602086015e5f602082860101526020601f19601f83011685010191505092915050565b6001600160a01b03851681526080602082018190525f90611222908301866111d1565b828103604084015261123481866111d1565b915050821515606083015295945050505050565b602081525f61125a60208301846111d1565b9392505050565b634e487b7160e01b5f52604160045260245ffd5b604051601f8201601f1916810167ffffffffffffffff8111828210171561129e5761129e611261565b604052919050565b5f5f604083850312156112b7575f5ffd5b82359150602083013567ffffffffffffffff8111156112d4575f5ffd5b8301601f810185136112e4575f5ffd5b803567ffffffffffffffff8111156112fe576112fe611261565b8060051b61130e60208201611275565b91825260208184018101929081019088841115611329575f5ffd5b6020850192505b838310156113cb57823567ffffffffffffffff81111561134e575f5ffd5b8501603f81018a1361135e575f5ffd5b602081013567ffffffffffffffff81111561137b5761137b611261565b61138e601f8201601f1916602001611275565b8181526040838301018c10156113a2575f5ffd5b816040840160208301375f60208383010152808552505050602082019150602083019250611330565b80955050505050509250929050565b5f602082840312156113ea575f5ffd5b5035919050565b634e487b7160e01b5f52602160045260245ffd5b8681526001600160a01b038616602082015260c081016007861061143757634e487b7160e01b5f52602160045260245ffd5b8560408301528460608301528360808301528260a0830152979650505050505050565b5f602082016020835280845180835260408501915060408160051b8601019250602086015f5b828110156114b157603f1987860301845261149c8583516111d1565b94506020938401939190910190600101611480565b50929695505050505050565b5f602082016020835280845180835260408501915060408160051b8601019250602086015f5b828110156114b157868503603f19018452815180516001600160a01b0316865260208082015160809188018290529061151e908801826111d1565b90506040820151878203604089015261153782826111d1565b6060938401511515989093019790975250945060209384019391909101906001016114e3565b5f5f83601f84011261156d575f5ffd5b50813567ffffffffffffffff811115611584575f5ffd5b60208301915083602082850101111561159b575f5ffd5b9250929050565b5f5f5f5f5f606086880312156115b6575f5ffd5b85359450602086013567ffffffffffffffff8111156115d3575f5ffd5b6115df8882890161155d565b909550935050604086013567ffffffffffffffff8111156115fe575f5ffd5b61160a8882890161155d565b969995985093965092949392505050565b80356001600160a01b0381168114611631575f5ffd5b919050565b5f5f60408385031215611647575f5ffd5b823591506116576020840161161b565b90509250929050565b5f5f5f5f60608587031215611673575f5ffd5b843593506116836020860161161b565b9250604085013567ffffffffffffffff81111561169e575f5ffd5b6116aa8782880161155d565b95989497509550505050565b600181811c908216806116ca57607f821691505b6020821081036116e857634e487b7160e01b5f52602260045260245ffd5b50919050565b634e487b7160e01b5f52603260045260245ffd5b5f6001820161171f57634e487b7160e01b5f52601160045260245ffd5b5060010190565b601f82111561176d57805f5260205f20601f840160051c8101602085101561174b5750805b601f840160051c820191505b8181101561176a575f8155600101611757565b50505b505050565b815167ffffffffffffffff81111561178c5761178c611261565b6117a08161179a84546116b6565b84611726565b6020601f8211600181146117d2575f83156117bb5750848201515b5f19600385901b1c1916600184901b17845561176a565b5f84815260208120601f198516915b8281101561180157878501518255602094850194600190920191016117e1565b508482101561181e57868401515f19600387901b60f8161c191681555b50505050600190811b01905550565b6001600160a01b03841681526040602082018190528101829052818360608301375f818301606090810191909152601f909201601f1916010192915050565b67ffffffffffffffff83111561188457611884611261565b6118988361189283546116b6565b83611726565b5f601f8411600181146118c9575f85156118b25750838201355b5f19600387901b1c1916600186901b17835561176a565b5f83815260208120601f198716915b828110156118f857868501358255602094850194600190920191016118d8565b5086821015611914575f1960f88860031b161c19848701351681555b505060018560011b018355505050505056fea2646970667358221220a5d1d71a2b05e4b4547d4f81bdedb340ee5f4832d7ed42e7e477a9d0bd64228a64736f6c634300081c0033",
  "linkReferences": {},
  "deployedLinkReferences": {},
  "immutableReferences": {},
  "inputSourceName": "project/contracts/MafiaPortal.sol",
  "buildInfoId": "solc-0_8_28-e21603999e8ad60fb338bfe3588efb0fd0b03921"
}

==================================================
FILE PATH: contracts/config.ts
==================================================
import MafiaABI from './MafiaPortal.json';

export const MAFIA_CONTRACT_ADDRESS = "0x32D3612009c2d30C71C19d2548822E1EECb8D165";
export const MAFIA_ABI = MafiaABI.abi;

==================================================
FILE PATH: index.html
==================================================
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Somnia Mafia</title>
    <!-- We keep Tailwind CDN for simplicity, but in a real build you might import it in CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap');
      
      body {
        font-family: 'Space Grotesk', sans-serif;
        background-color: #050505;
        color: #e2e8f0;
      }
      .font-mono {
        font-family: 'JetBrains Mono', monospace;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #111;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.35.0",
    "framer-motion": "https://esm.sh/framer-motion@^12.25.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "ethers": "https://esm.sh/ethers@^6.16.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>

==================================================
FILE PATH: index.tsx
==================================================
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import App from './App';
import { Web3Provider } from './components/Web3Provider';
import { GameProvider } from './contexts/GameContext';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <Web3Provider>
      <BrowserRouter>
        <GameProvider>
          <App />
        </GameProvider>
      </BrowserRouter>
    </Web3Provider>
  </React.StrictMode>
);

==================================================
FILE PATH: metadata.json
==================================================
{
  "name": "Somnia Mafia Web3",
  "description": "A decentralized social deduction game interface using System Logs and ZK-ready architecture.",
  "requestFramePermissions": []
}

==================================================
FILE PATH: package.json
==================================================
{
  "name": "somnia-mafia-web3",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^1.20.0",
    "@rainbow-me/rainbowkit": "^2.2.10",
    "@tanstack/react-query": "^5.90.16",
    "clsx": "^2.1.1",
    "ethers": "^6.13.5",
    "framer-motion": "^11.15.0",
    "lucide-react": "^0.469.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^7.12.0",
    "tailwind-merge": "^2.6.0",
    "viem": "^2.44.0",
    "wagmi": "^2.19.5"
  },
  "devDependencies": {
    "@types/react": "^18.3.18",
    "@types/react-dom": "^18.3.5",
    "@vitejs/plugin-react": "^4.3.4",
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.17",
    "typescript": "^5.7.2",
    "vite": "^5.4.11"
  }
}


==================================================
FILE PATH: services/cryptoUtils.ts
==================================================
// services/cryptoUtils.ts

export const generateKeyPair = async () => {
    return await window.crypto.subtle.generateKey(
        {
            name: "RSA-OAEP",
            modulusLength: 2048,
            publicExponent: new Uint8Array([1, 0, 1]),
            hash: "SHA-256",
        },
        true,
        ["encrypt", "decrypt"]
    );
};

export const exportPublicKey = async (key: CryptoKey): Promise<string> => {
    const exported = await window.crypto.subtle.exportKey("spki", key);
    return btoa(String.fromCharCode(...new Uint8Array(exported)));
};

export const importPublicKey = async (pem: string): Promise<CryptoKey> => {
    const binaryDerString = atob(pem);
    const binaryDer = new Uint8Array(binaryDerString.length);
    for (let i = 0; i < binaryDerString.length; i++) {
        binaryDer[i] = binaryDerString.charCodeAt(i);
    }
    return await window.crypto.subtle.importKey(
        "spki",
        binaryDer.buffer,
        { name: "RSA-OAEP", hash: "SHA-256" },
        true,
        ["encrypt"]
    );
};

==================================================
FILE PATH: services/geminiService.ts
==================================================
import { GoogleGenAI } from "@google/genai";
import { GamePhase, Role } from "../types";

// Note: In a production app, you should proxy these requests through a backend
// to protect your API Key. For this demo, it relies on process.env.API_KEY.

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const MODEL_ID = "gemini-3-flash-preview";

export const generateNarrative = async (
  phase: GamePhase,
  dayCount: number,
  events: string[]
): Promise<string> => {
  if (!process.env.API_KEY) {
    return "Narrator (Offline): The API Key is missing. Imagine a suspenseful description here.";
  }

  let prompt = "";

  switch (phase) {
    case GamePhase.NIGHT:
      prompt = `It is Night ${dayCount}. The village of Somnia goes to sleep. Describe the eerie atmosphere in 2 sentences. Keep it dark and mysterious.`;
      break;
    case GamePhase.DAY:
      prompt = `It is Day ${dayCount}. The sun rises. ${events.join(" ")} Describe the reaction of the villagers in 2 sentences.`;
      break;
    case GamePhase.GAME_OVER:
      prompt = `The game is over. ${events.join(" ")} Write a short 2-sentence epilogue about the fate of the village.`;
      break;
    default:
      return "";
  }

  try {
    const response = await ai.models.generateContent({
      model: MODEL_ID,
      contents: prompt,
    });
    return response.text || "The wind howls silently...";
  } catch (error) {
    console.error("Gemini Error:", error);
    return "A strange static interference disrupts the narrator...";
  }
};

export const generateRoleDescription = async (role: Role): Promise<string> => {
    if (!process.env.API_KEY) return "You have been assigned a role.";
    
    const prompt = `You are the Game Master. A player has been assigned the role: ${role}. 
    Write a short, immersive 1-sentence description telling them what they must do to win. 
    Tone: Dark, serious Web3 cyberpunk.`;

    try {
        const response = await ai.models.generateContent({
            model: MODEL_ID,
            contents: prompt
        });
        return response.text || "Execute your mission.";
    } catch (e) {
        return "System failure. Check connection.";
    }
}

==================================================
FILE PATH: services/mentalPokerService.ts
==================================================
// services/mentalPokerService.ts

// Простое поле Галуа для учебного Mental Poker (в продакшене нужны большие простые числа)
// Используем BigInt для работы с большими числами
const PRIME = 2147483647n; // Мерсенн 2^31 - 1 (для примера, чтобы работало быстро)

export class MentalPokerService {
    private key: bigint; // Мой секретный ключ

    constructor() {
        // Генерируем случайный секретный ключ
        this.key = BigInt(Math.floor(Math.random() * 1000000)) + 1n;
    }

    // Функция возведения в степень по модулю (Modular Exponentiation)
    // base^exp % mod
    private modPow(base: bigint, exp: bigint, mod: bigint): bigint {
        let res = 1n;
        base = base % mod;
        while (exp > 0n) {
            if (exp % 2n === 1n) res = (res * base) % mod;
            exp = exp / 2n;
            base = (base * base) % mod;
        }
        return res;
    }

    // Шифрование карты: (Card ^ Key) % Prime
    public encryptCard(cardValue: number): string {
        const val = BigInt(cardValue);
        return this.modPow(val, this.key, PRIME).toString();
    }

    // Шифрование уже зашифрованной карты (Commutative)
    public encryptEncrypted(encryptedValue: string): string {
        const val = BigInt(encryptedValue);
        return this.modPow(val, this.key, PRIME).toString();
    }

    // Расшифровка (требует вычисления обратного ключа - Modular Inverse)
    // В реальном SRA тут сложнее, но для игры мы будем делать схему "Раскрытие ключей"
    // Мы просто отдадим свой ключ в конце раздачи
    public getKey(): string {
        return this.key.toString();
    }

    // Расшифровка карты чужим ключом (зная P-1)
    // Для упрощения мы будем использовать XOR-шифрование или просто передачу ключей
    // Но давайте сделаем симуляцию для MVP:

    // ГЕНЕРАЦИЯ КОЛОДЫ (только Хост)
    // 1 = Мафия, 2 = Доктор, 3 = Детектив, 4+ = Мирные
    public static generateDeck(playerCount: number): number[] {
        const deck = [1, 2, 3]; // Спецроли
        for (let i = 3; i < playerCount; i++) {
            deck.push(4 + i); // Уникальные ID мирных жителей
        }
        // Перемешиваем (Фишер-Йетс)
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
        return deck;
    }
}

==================================================
FILE PATH: services/mockData.ts
==================================================
import { Player, Role } from '../types';

export const MOCK_LOBBIES = [
    { id: 1, name: "Chill Mafia Game", players: 12, max: 16 },
    { id: 2, name: "Experts Only", players: 15, max: 16 },
    { id: 3, name: "Fast Game", players: 4, max: 16 },
    { id: 4, name: "Midnight Club", players: 8, max: 16 },
];

export const MOCK_PLAYERS: Player[] = Array.from({ length: 8 }).map((_, i) => ({
    id: `p-${i}`,
    name: `Player ${i + 1}`,
    nickname: `User${i + 1}`,
    address: `0x${Math.random().toString(16).slice(2, 42)}`,
    role: Role.CIVILIAN, // Will be shuffled
    isAlive: true,
    avatarUrl: `https://picsum.photos/seed/${i + 200}/200`,
    votesReceived: 0,
    status: 'connected'
}));

export const generateMockPlayers = (count: number, hostName: string): { name: string; address: string }[] => {
    return Array(count).fill(null).map((_, i) => ({
        name: i === 0 ? (hostName || 'Host') : 'Haiman',
        address: `0x9c...${Math.floor(Math.random() * 1000).toString(16)}`
    }));
};


==================================================
FILE PATH: tsconfig.json
==================================================
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["."],
  "references": [{ "path": "./tsconfig.node.json" }]
}

==================================================
FILE PATH: tsconfig.node.json
==================================================
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}

==================================================
FILE PATH: types/images.d.ts
==================================================
declare module '*.jpg' {
    const value: string;
    export default value;
}

declare module '*.png' {
    const value: string;
    export default value;
}

declare module '*.svg' {
    const value: string;
    export default value;
}


==================================================
FILE PATH: types.ts
==================================================
export enum Role {
  CIVILIAN = 'CIVILIAN',
  MAFIA = 'MAFIA',
  DETECTIVE = 'DETECTIVE',
  DOCTOR = 'DOCTOR',
  UNKNOWN = 'UNKNOWN' // For other players
}

export enum GamePhase {
  LOBBY = 'LOBBY',
  ROLE_REVEAL = 'ROLE_REVEAL',
  NIGHT = 'NIGHT',
  DAY = 'DAY',
  VOTING = 'VOTING',
  GAME_OVER = 'GAME_OVER',
  SHUFFLING = "SHUFFLING"
}

export type ConnectionStatus = 'connected' | 'syncing' | 'offline' | 'slashed';

export interface Player {
  id: string;
  name: string;
  address: string; // Wallet address
  role: Role; // In a real app, this is hidden for others!
  isAlive: boolean;
  avatarUrl: string;
  votesReceived: number;
  status: ConnectionStatus;
}

export interface LogEntry {
  id: string;
  timestamp: string;
  message: string;
  type: 'info' | 'danger' | 'success' | 'phase' | 'warning';
}

export interface GameState {
  phase: GamePhase;
  dayCount: number;
  players: Player[];
  myPlayerId: string | null;
  logs: LogEntry[];
  winner: 'MAFIA' | 'CIVILIANS' | null;
}

// For Framer Motion variants
export const cardVariants = {
  hidden: { opacity: 0, y: 20 },
  visible: { opacity: 1, y: 0 },
  exit: { opacity: 0, scale: 0.9 }
};

==================================================
FILE PATH: vite.config.d.ts
==================================================
declare const _default: import("vite").UserConfigFnObject;
export default _default;


==================================================
FILE PATH: vite.config.js
==================================================
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';
// https://vitejs.dev/config/
export default defineConfig(function (_a) {
    var mode = _a.mode;
    var env = loadEnv(mode, process.cwd(), '');
    return {
        plugins: [react()],
        define: {
            // This ensures process.env.API_KEY works in the browser for the GenAI SDK
            'process.env.API_KEY': JSON.stringify(env.API_KEY),
            // Fallback for other process.env calls if necessary
            'process.env': {}
        }
    };
});


==================================================
FILE PATH: vite.config.ts
==================================================
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

// https://vitejs.dev/config/
export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), '');
  return {
    plugins: [react()],
    define: {
      // This ensures process.env.API_KEY works in the browser for the GenAI SDK
      'process.env.API_KEY': JSON.stringify(env.API_KEY),
      // Fallback for other process.env calls if necessary
      'process.env': {}
    }
  };
});

